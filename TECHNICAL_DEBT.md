# 技术债务清单

**项目**: gomockserver  
**创建日期**: 2025-01-21  
**最后更新**: 2025-11-17  
**负责人**: 开发团队

---

## 📋 概述

本文档跟踪 gomockserver 项目中的技术债务，包括待实现的功能、已知的限制和计划中的改进。所有技术债务按优先级分类，并指定目标版本。

### 统计信息

| 类别 | 数量 | 状态 |
|------|------|------|
| P1 - 高优先级 | 0 | ✅ 已完成 |
| P2 - 中优先级 | 2 | 🟡 计划中 |
| P3 - 低优先级 | 2 | 🟢 远期规划 |
| **总计** | **4** | - |
| **已解决** | **5** | ✅ v0.2.0 |

---

## ✅ 已解决（v0.2.0）

### TD-001: CIDR 格式 IP 段匹配 ✅

**状态**: ✅ 已完成（v0.2.0）

**实现细节**:
- 实现文件: `internal/engine/match_engine.go:386-419`
- 支持 CIDR 格式（如 `192.168.1.0/24`）
- 向下兼容单个 IP 地址匹配
- 使用 Go 标准库 `net.ParseCIDR` 实现

---

### TD-002: 正则表达式匹配 ✅

**状态**: ✅ 已完成（v0.2.0）

**实现细节**:
- 实现文件: 
  - `internal/engine/match_engine.go:187-300` - 正则匹配逻辑
  - `internal/engine/lru_cache.go` - LRU 缓存
  - `internal/engine/regex_validator.go` - 正则验证器
  - `internal/engine/common_patterns.go` - 通用模式库
- 支持路径、Header、Query 参数的正则匹配
- LRU 缓存机制（默认 1000 条）
- ReDoS 防护（复杂度检测 + 超时机制）
- 预定义常用正则模式

---

### TD-003: 二进制数据处理 ✅

**状态**: ✅ 已完成（v0.2.0）

**实现细节**:
- 实现文件: `internal/executor/mock_executor.go:101-119`
- 支持 Base64 编码的二进制响应
- Content-Type 自动检测
- 支持图片、PDF 等二进制文件 Mock

---

### TD-004: 正态分布延迟策略 ✅

**状态**: ✅ 已完成（v0.2.0）

**实现细节**:
- 实现文件: `internal/executor/mock_executor.go:156-172`
- 使用 Marsaglia polar method 生成正态分布随机数
- 支持配置平均值（mean）和标准差（stddev）
- 更贴近真实网络延迟分布

---

### TD-005: 阶梯延迟策略 ✅

**状态**: ✅ 已完成（v0.2.0）

**实现细节**:
- 实现文件: `internal/executor/mock_executor.go:173-211`
- 根据请求次数递增延迟
- 支持配置初始延迟、步长、最大延迟
- 基于计数器实现（线程安全）
- 可用于模拟服务过载和降级场景

**后续优化计划**（v0.3.0）:
- 按规则 ID 隔离计数器
- 支持计数器重置
- 计数器持久化（可选）

---

## 🟡 P2 - 中优先级 (v0.3.0 - v0.4.0)

---

### TD-006: 脚本匹配

**文件**: `internal/engine/match_engine.go:146`

**描述**: 不支持使用脚本进行动态匹配（JavaScript、Lua 等）。

**影响**:
- 无法实现复杂的业务逻辑匹配
- 无法动态计算匹配条件

**建议实现**:
- 集成 JavaScript 引擎（如 goja）
- 或集成 Lua 引擎（如 gopher-lua）
- 提供安全沙箱环境

**安全风险**: ⚠️ 高
- 需要严格的脚本沙箱
- 需要资源限制（CPU、内存、执行时间）
- 需要审计日志

**工作量**: 大 (10-15小时)  
**目标版本**: v0.4.0  
**负责人**: 待分配  
**状态**: 🟡 计划中

---

### TD-007: WebSocket 支持

**文件**: `internal/executor/mock_executor.go:38`

**描述**: 当前只支持 HTTP/HTTPS 协议，不支持 WebSocket。

**影响**:
- 无法 Mock WebSocket 接口
- 无法测试实时通信功能

**建议实现**:
- 使用 gorilla/websocket 库
- 支持消息推送
- 支持双向通信

**工作量**: 大 (12-16小时)  
**目标版本**: v0.4.0  
**负责人**: 待分配  
**状态**: 🟡 计划中

---

## 🟢 P3 - 低优先级 (v0.4.0+)

### TD-008: gRPC 支持

**文件**: `internal/executor/mock_executor.go:41`

**描述**: 不支持 gRPC 协议的 Mock。

**影响**:
- 无法 Mock gRPC 服务
- 限制了微服务场景的使用

**建议实现**:
- 使用 grpc-go 库
- 支持动态 proto 解析
- 支持流式 RPC

**工作量**: 大 (15-20小时)  
**目标版本**: v0.8.0  
**负责人**: 待分配  
**状态**: 🟢 远期规划

---

### TD-009: TCP 协议支持

**文件**: `internal/executor/mock_executor.go:44`

**描述**: 不支持原始 TCP 协议的 Mock。

**影响**:
- 无法 Mock TCP 服务
- 无法测试底层网络协议

**建议实现**:
- 实现 TCP Server
- 支持自定义协议解析
- 支持长连接

**工作量**: 大 (10-15小时)  
**目标版本**: v0.8.0  
**负责人**: 待分配  
**状态**: 🟢 远期规划

---

## 📊 优先级评估矩阵

| ID | 技术债务 | 状态 | 完成版本 |
|----|---------|------|----------|
| TD-001 | CIDR IP 匹配 | ✅ 已完成 | v0.2.0 |
| TD-002 | 正则匹配 | ✅ 已完成 | v0.2.0 |
| TD-003 | 二进制数据 | ✅ 已完成 | v0.2.0 |
| TD-004 | 正态分布延迟 | ✅ 已完成 | v0.2.0 |
| TD-005 | 阶梯延迟 | ✅ 已完成 | v0.2.0 |
| TD-006 | 脚本匹配 | 🟡 计划中 | v0.4.0 |
| TD-007 | WebSocket | 🟡 计划中 | v0.4.0 |
| TD-008 | gRPC 支持 | 🟢 远期规划 | v0.8.0 |
| TD-009 | TCP 支持 | 🟢 远期规划 | v0.8.0 |

---

## 📅 实施计划

### v0.2.0 (2025-11-17) ✅ 已完成
- [x] TD-001: CIDR IP 匹配
- [x] TD-002: 正则表达式匹配
- [x] TD-003: 二进制数据处理
- [x] TD-004: 正态分布延迟
- [x] TD-005: 阶梯延迟

### v0.3.0 (2025-12)
- [ ] 动态响应模板
- [ ] 代理模式
- [ ] 文件路径引用
- [ ] 阶梯延迟优化

### v0.4.0 (2026-01)
- [ ] TD-006: 脚本匹配（需安全评估）
- [ ] TD-007: WebSocket 支持

### v0.8.0 (2026-05)
- [ ] TD-008: gRPC 支持
- [ ] TD-009: TCP 协议支持

---

## 🔄 变更记录

| 日期 | 变更内容 | 操作人 |
|------|---------|--------|
| 2025-11-17 | 更新 v0.2.0 完成状态，标记 TD-001~TD-005 已解决 | AI Assistant |
| 2025-01-21 | 创建技术债务清单，录入 9 个 TODO 项 | AI Code Review |

---

## 📝 备注

### 安全考虑

对于以下功能需要特别注意安全性：
- **TD-006 脚本匹配**: 需要严格的沙箱环境
- **TD-008 gRPC**: 需要防止恶意 proto 定义
- **TD-009 TCP**: 需要防止资源耗尽攻击

### 性能考虑

- **TD-002 正则匹配**: 需要缓存编译后的正则表达式
- **TD-007 WebSocket**: 需要连接数限制
- **TD-008 gRPC**: 需要流量控制

### 兼容性

所有新功能应保持向后兼容，不影响现有规则的运行。

---

**文档维护**: 每次 Sprint 结束后更新此文档  
**审查周期**: 每 2 周审查一次  
**联系方式**: 开发团队
