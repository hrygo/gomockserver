# gomockserver 数据流路径文档

<cite>
**本文档中引用的文件**
- [internal/adapter/http_adapter.go](file://internal/adapter/http_adapter.go)
- [internal/service/mock_service.go](file://internal/service/mock_service.go)
- [internal/engine/match_engine.go](file://internal/engine/match_engine.go)
- [internal/repository/rule_repository.go](file://internal/repository/rule_repository.go)
- [internal/executor/mock_executor.go](file://internal/executor/mock_executor.go)
- [internal/adapter/adapter.go](file://internal/adapter/adapter.go)
- [internal/models/models.go](file://internal/models/models.go)
- [internal/models/errors.go](file://internal/models/errors.go)
- [internal/api/health_handler.go](file://internal/api/health_handler.go)
</cite>

## 目录
1. [概述](#概述)
2. [系统架构概览](#系统架构概览)
3. [数据流路径详解](#数据流路径详解)
4. [关键组件分析](#关键组件分析)
5. [上下文传递机制](#上下文传递机制)
6. [异常处理流程](#异常处理流程)
7. [性能优化考虑](#性能优化考虑)
8. [总结](#总结)

## 概述

gomockserver 是一个基于 Go 语言构建的 Mock 服务器，采用分层架构设计，通过清晰的数据流路径实现了从 HTTP 请求到响应返回的完整处理链路。本文档详细追踪了从客户端请求到最终响应返回的完整数据流，并重点说明了上下文（context）在跨层调用中的传递和超时控制机制。

## 系统架构概览

gomockserver 采用典型的分层架构模式，主要包含以下核心层次：

```mermaid
graph TB
subgraph "客户端层"
Client[HTTP 客户端]
end
subgraph "接入层"
Gin[Gin Web 框架]
HTTPAdapter[HTTP 适配器]
end
subgraph "业务逻辑层"
MockService[Mock 服务]
MatchEngine[匹配引擎]
MockExecutor[Mock 执行器]
end
subgraph "数据访问层"
RuleRepository[规则仓库]
MongoDB[MongoDB 数据库]
end
Client --> Gin
Gin --> HTTPAdapter
HTTPAdapter --> MockService
MockService --> MatchEngine
MockService --> MockExecutor
MatchEngine --> RuleRepository
RuleRepository --> MongoDB
MockExecutor --> HTTPAdapter
HTTPAdapter --> Gin
Gin --> Client
```

**图表来源**
- [internal/adapter/http_adapter.go](file://internal/adapter/http_adapter.go#L1-L113)
- [internal/service/mock_service.go](file://internal/service/mock_service.go#L1-L116)
- [internal/engine/match_engine.go](file://internal/engine/match_engine.go#L1-L436)
- [internal/repository/rule_repository.go](file://internal/repository/rule_repository.go#L1-L196)

## 数据流路径详解

### 完整数据流序列图

```mermaid
sequenceDiagram
participant Client as 客户端
participant Gin as Gin 框架
participant HTTPAdapter as HTTP 适配器
participant MockService as Mock 服务
participant MatchEngine as 匹配引擎
participant RuleRepository as 规则仓库
participant MongoDB as MongoDB
participant MockExecutor as Mock 执行器
participant HTTPAdapter2 as HTTP 适配器(响应)
Note over Client,MongoDB : HTTP 请求处理流程
Client->>Gin : HTTP 请求 (/ : projectID/ : environmentID/*path)
Gin->>HTTPAdapter : Parse(gin.Context)
HTTPAdapter->>HTTPAdapter : 解析请求头、路径、参数
HTTPAdapter-->>Gin : 统一 Request 模型
Gin->>MockService : HandleMockRequest(Context)
Note over MockService,MatchEngine : 规则匹配阶段
MockService->>MatchEngine : Match(Context, Request, projectID, environmentID)
MatchEngine->>RuleRepository : FindEnabledByEnvironment(Context, projectID, environmentID)
RuleRepository->>MongoDB : 查询启用的规则
MongoDB-->>RuleRepository : 规则列表
RuleRepository-->>MatchEngine : 规则列表
MatchEngine->>MatchEngine : 逐条匹配规则
MatchEngine-->>MockService : 匹配的规则或 nil
alt 匹配到规则
MockService->>MockExecutor : Execute(Request, Rule)
MockExecutor->>MockExecutor : 生成响应内容
MockExecutor-->>MockService : 响应对象
else 未匹配到规则
MockService->>MockExecutor : GetDefaultResponse()
MockExecutor-->>MockService : 默认 404 响应
end
MockService->>HTTPAdapter2 : WriteResponse(Context, Response)
HTTPAdapter2->>HTTPAdapter2 : 设置响应头和状态码
HTTPAdapter2-->>Gin : 写入响应
Gin-->>Client : HTTP 响应
```

**图表来源**
- [internal/adapter/http_adapter.go](file://internal/adapter/http_adapter.go#L21-L84)
- [internal/service/mock_service.go](file://internal/service/mock_service.go#L42-L98)
- [internal/engine/match_engine.go](file://internal/engine/match_engine.go#L43-L76)
- [internal/repository/rule_repository.go](file://internal/repository/rule_repository.go#L140-L160)
- [internal/executor/mock_executor.go](file://internal/executor/mock_executor.go#L49-L71)

### 请求解析阶段

HTTP 请求从客户端到达服务器后，经过以下处理步骤：

1. **Gin 框架接收请求**：Gin 框架解析 HTTP 请求，提取路径参数（projectID、environmentID、path）
2. **HTTP 适配器解析**：HTTPAdapter.Parse 方法将 gin.Context 转换为统一的 Request 模型
3. **数据提取**：
   - 生成唯一请求 ID
   - 读取请求体内容
   - 提取请求头信息
   - 解析查询参数
   - 获取客户端 IP 地址
   - 提取实际 API 路径

**节来源**
- [internal/adapter/http_adapter.go](file://internal/adapter/http_adapter.go#L21-L84)

### 规则匹配阶段

匹配引擎按照以下流程处理请求匹配：

1. **加载规则**：RuleRepository.FindEnabledByEnvironment 查询指定环境下的所有启用规则
2. **按优先级排序**：规则按照优先级降序排列
3. **逐条匹配**：MatchEngine.Match 遍历规则列表，执行匹配逻辑
4. **匹配类型支持**：
   - Simple：精确匹配和简单通配符匹配
   - Regex：正则表达式匹配
   - Script：脚本匹配（待实现）

**节来源**
- [internal/engine/match_engine.go](file://internal/engine/match_engine.go#L43-L76)
- [internal/repository/rule_repository.go](file://internal/repository/rule_repository.go#L140-L160)

### 响应生成阶段

根据匹配结果生成响应：

1. **静态响应**：直接返回预定义的响应内容
2. **动态响应**：使用模板引擎渲染动态内容
3. **代理响应**：转发请求到目标服务
4. **默认响应**：当没有匹配规则时返回 404

**节来源**
- [internal/executor/mock_executor.go](file://internal/executor/mock_executor.go#L49-L71)

## 关键组件分析

### HTTP 适配器（HTTPAdapter）

HTTP 适配器负责协议无关的请求和响应处理：

```mermaid
classDiagram
class HTTPAdapter {
+Parse(rawRequest) Request
+Build(response) interface{}
+WriteResponse(c, response)
-getContentType(headers) string
}
class Request {
+string ID
+ProtocolType Protocol
+map Metadata
+string Path
+map Headers
+[]byte Body
+string SourceIP
+time ReceivedAt
}
class Response {
+int StatusCode
+map Headers
+[]byte Body
+map Metadata
}
HTTPAdapter --> Request : "创建"
HTTPAdapter --> Response : "创建"
```

**图表来源**
- [internal/adapter/http_adapter.go](file://internal/adapter/http_adapter.go#L14-L113)
- [internal/adapter/adapter.go](file://internal/adapter/adapter.go#L9-L39)

### Mock 服务（MockService）

Mock 服务是核心业务逻辑组件，协调各个子系统：

```mermaid
classDiagram
class MockService {
-HTTPAdapter httpAdapter
-MatchEngineInterface matchEngine
-MockExecutorInterface mockExecutor
+HandleMockRequest(c)
+StartMockServer(addr, service)
}
class MatchEngineInterface {
<<interface>>
+Match(ctx, request, projectID, environmentID) Rule
}
class MockExecutorInterface {
<<interface>>
+Execute(request, rule) Response
+GetDefaultResponse() Response
}
MockService --> MatchEngineInterface
MockService --> MockExecutorInterface
MockService --> HTTPAdapter
```

**图表来源**
- [internal/service/mock_service.go](file://internal/service/mock_service.go#L25-L39)

### 匹配引擎（MatchEngine）

匹配引擎实现复杂的规则匹配逻辑：

```mermaid
flowchart TD
Start([开始匹配]) --> LoadRules[加载规则列表]
LoadRules --> SortByPriority[按优先级排序]
SortByPriority --> LoopRules{遍历规则}
LoopRules --> CheckProtocol{检查协议类型}
CheckProtocol --> |不匹配| NextRule[下一个规则]
CheckProtocol --> |匹配| MatchRule[执行规则匹配]
MatchRule --> MatchType{匹配类型}
MatchType --> |Simple| SimpleMatch[简单匹配]
MatchType --> |Regex| RegexMatch[正则匹配]
MatchType --> |Script| ScriptMatch[脚本匹配]
SimpleMatch --> MatchResult{匹配结果}
RegexMatch --> MatchResult
ScriptMatch --> MatchResult
MatchResult --> |匹配成功| ReturnRule[返回规则]
MatchResult --> |匹配失败| NextRule
NextRule --> LoopRules
LoopRules --> |无更多规则| ReturnNil[返回 nil]
ReturnRule --> End([结束])
ReturnNil --> End
```

**图表来源**
- [internal/engine/match_engine.go](file://internal/engine/match_engine.go#L43-L76)

### 规则仓库（RuleRepository）

规则仓库提供 MongoDB 数据访问接口：

| 方法 | 功能 | 查询条件 |
|------|------|----------|
| FindEnabledByEnvironment | 查找环境下所有启用的规则 | project_id, environment_id, enabled=true |
| FindByEnvironment | 查找环境下的所有规则 | project_id, environment_id |
| FindByID | 根据ID查找规则 | _id |
| Create | 创建新规则 | 完整规则对象 |
| Update | 更新规则 | 规则ID和更新内容 |
| Delete | 删除规则 | 规则ID |

**节来源**
- [internal/repository/rule_repository.go](file://internal/repository/rule_repository.go#L14-L23)

### Mock 执行器（MockExecutor）

Mock 执行器处理不同类型的响应生成：

```mermaid
flowchart TD
Start([开始执行]) --> CheckDelay{是否有延迟配置}
CheckDelay --> |是| CalculateDelay[计算延迟时间]
CheckDelay --> |否| CheckType{响应类型}
CalculateDelay --> Sleep[休眠延迟时间]
Sleep --> CheckType
CheckType --> |Static| StaticResponse[静态响应]
CheckType --> |Dynamic| DynamicResponse[动态响应]
CheckType --> |Proxy| ProxyResponse[代理响应]
CheckType --> |Script| ScriptResponse[脚本响应]
StaticResponse --> BuildResponse[构建响应对象]
DynamicResponse --> TemplateEngine[模板引擎渲染]
TemplateEngine --> BuildResponse
ProxyResponse --> ProxyExecutor[代理执行器]
ProxyExecutor --> BuildResponse
ScriptResponse --> ScriptEngine[脚本引擎]
ScriptEngine --> BuildResponse
BuildResponse --> End([结束])
```

**图表来源**
- [internal/executor/mock_executor.go](file://internal/executor/mock_executor.go#L49-L71)

## 上下文传递机制

### 上下文生命周期

gomockserver 中的上下文传递遵循以下模式：

```mermaid
sequenceDiagram
participant Gin as Gin 框架
participant MockService as Mock 服务
participant MatchEngine as 匹配引擎
participant RuleRepository as 规则仓库
participant MongoDB as MongoDB
participant MockExecutor as Mock 执行器
Note over Gin,MongoDB : 上下文传递流程
Gin->>MockService : HandleMockRequest(Context)
Note right of MockService : 使用 gin.Context<br/>支持请求取消和超时
MockService->>MatchEngine : Match(Context, ...)
Note right of MatchEngine : 传递上下文<br/>支持数据库查询超时
MatchEngine->>RuleRepository : FindEnabledByEnvironment(Context, ...)
Note right of RuleRepository : 传递上下文<br/>确保数据库操作超时
RuleRepository->>MongoDB : 查询操作
Note right of MongoDB : 使用上下文<br/>支持查询超时控制
MockService->>MockExecutor : Execute(Context, ...)
Note right of MockExecutor : 可能使用新的上下文<br/>用于响应生成超时
```

**图表来源**
- [internal/service/mock_service.go](file://internal/service/mock_service.go#L66-L67)
- [internal/engine/match_engine.go](file://internal/engine/match_engine.go#L44-L45)
- [internal/api/health_handler.go](file://internal/api/health_handler.go#L86-L88)

### 超时控制策略

系统在多个层面实施超时控制：

1. **健康检查超时**：
   - Health 接口：5秒超时
   - Metrics 接口：5秒超时  
   - Ready 接口：3秒超时

2. **数据库操作超时**：
   - 规则查询：继承 gin.Context 的超时
   - 数据库 Ping：5秒超时

3. **脚本执行超时**：
   - JavaScript 脚本：最大执行时间限制

**节来源**
- [internal/api/health_handler.go](file://internal/api/health_handler.go#L86-L221)

### 上下文取消机制

系统支持优雅的请求取消：

```mermaid
flowchart TD
ClientRequest[客户端请求] --> GinContext[创建 gin.Context]
GinContext --> WithCancel[context.WithCancel]
WithCancel --> RequestProcessing[请求处理]
RequestProcessing --> CheckCancel{检查取消信号}
CheckCancel --> |已取消| CleanupResources[清理资源]
CheckCancel --> |继续| ContinueProcessing[继续处理]
ContinueProcessing --> DatabaseQuery[数据库查询]
DatabaseQuery --> CheckCancel
CleanupResources --> ReturnError[返回错误]
ContinueProcessing --> Success[处理成功]
```

## 异常处理流程

### 异常传播路径

系统采用分层异常处理机制，确保错误能够正确传播：

```mermaid
flowchart TD
ClientRequest[客户端请求] --> ParseError{解析错误}
ParseError --> |错误| LogError[记录错误日志]
ParseError --> |成功| MatchError{匹配错误}
LogError --> Return500[返回 500 错误]
MatchError --> |错误| LogMatchError[记录匹配错误]
MatchError --> |成功| ExecuteError{执行错误}
LogMatchError --> Return500
ExecuteError --> |错误| LogExecError[记录执行错误]
ExecuteError --> |成功| WriteError{写入响应错误}
LogExecError --> Return500
WriteError --> |错误| LogWriteError[记录写入错误]
WriteError --> |成功| Success[处理成功]
LogWriteError --> Return500
Return500 --> ClientResponse[客户端响应]
Success --> ClientResponse
```

### 错误类型分类

系统定义了完整的错误码体系：

| 错误类别 | 错误码范围 | 示例错误 |
|----------|------------|----------|
| 通用错误 | 1000-1999 | 参数无效、未授权 |
| 项目相关 | 2000-2999 | 项目不存在、项目创建失败 |
| 环境相关 | 3000-3999 | 环境不存在、环境创建失败 |
| 规则相关 | 4000-4999 | 规则不存在、规则匹配失败 |
| 数据库相关 | 5000-5999 | 数据库连接失败、查询失败 |
| 系统错误 | 9000-9999 | 服务器内部错误、请求超时 |

**节来源**
- [internal/models/errors.go](file://internal/models/errors.go#L30-L212)

### 错误恢复策略

1. **数据库连接失败**：记录错误，返回 500 状态码
2. **规则匹配失败**：返回 500 状态码
3. **响应生成失败**：返回 500 状态码
4. **超时错误**：记录超时信息，返回 500 状态码

## 性能优化考虑

### 缓存机制

1. **正则表达式缓存**：MatchEngine 实现 LRU 缓存，避免重复编译正则表达式
2. **规则匹配缓存**：支持规则匹配结果缓存
3. **响应内容缓存**：静态响应内容可缓存

### 并发控制

1. **Goroutine 限制**：健康检查接口限制 Goroutine 数量
2. **数据库连接池**：使用连接池管理数据库连接
3. **超时控制**：各层级设置合理的超时时间

### 内存管理

1. **请求体缓冲**：合理控制请求体内存占用
2. **响应体优化**：支持大文件响应的流式处理
3. **垃圾回收优化**：减少不必要的内存分配

## 总结

gomockserver 的数据流路径设计体现了良好的软件架构原则：

1. **清晰的分层架构**：每一层都有明确的职责边界
2. **一致的接口设计**：各组件通过接口解耦，便于测试和扩展
3. **完善的上下文传递**：支持超时控制和优雅取消
4. **健壮的异常处理**：多层次的错误捕获和传播机制
5. **性能优化考虑**：缓存、并发控制等优化措施

该架构设计使得系统具有良好的可维护性、可扩展性和可靠性，能够满足生产环境的高并发和高可用需求。通过本文档的详细分析，开发者可以深入理解系统的数据流处理机制，并在此基础上进行功能扩展和性能优化。