# 数据模型

<cite>
**本文档中引用的文件**
- [models.go](file://internal/models/models.go)
- [database.go](file://internal/repository/database.go)
- [project_repository.go](file://internal/repository/project_repository.go)
- [rule_repository.go](file://internal/repository/rule_repository.go)
- [errors.go](file://internal/models/errors.go)
- [project_handler.go](file://internal/api/project_handler.go)
- [rule_handler.go](file://internal/api/rule_handler.go)
- [mongoinit.js](file://config/redis/mongoinit.js)
</cite>

## 目录
1. [简介](#简介)
2. [核心数据模型](#核心数据模型)
3. [集合映射关系](#集合映射关系)
4. [索引设计](#索引设计)
5. [数据生命周期管理](#数据生命周期管理)
6. [项目级别数据隔离](#项目级别数据隔离)
7. [数据访问模式](#数据访问模式)
8. [查询性能考量](#查询性能考量)
9. [错误处理机制](#错误处理机制)
10. [总结](#总结)

## 简介

Go Mock Server采用MongoDB作为主要数据存储，通过精心设计的数据模型支持Mock服务的核心功能。本文档详细阐述了Rule、Project、Environment等核心实体的数据结构、约束条件、索引设计以及查询优化策略。

## 核心数据模型

### Rule（规则）模型

Rule是系统的核心实体，代表一个完整的Mock规则配置。

```mermaid
classDiagram
class Rule {
+string ID
+string Name
+string ProjectID
+string EnvironmentID
+ProtocolType Protocol
+MatchType MatchType
+int Priority
+bool Enabled
+map[string]interface{} MatchCondition
+Response Response
+[]string Tags
+string Creator
+time.Time CreatedAt
+time.Time UpdatedAt
}
class Response {
+ResponseType Type
+DelayConfig Delay
+map[string]interface{} Content
}
class DelayConfig {
+string Type
+int Min
+int Max
+int Fixed
+int Mean
+int StdDev
+int Step
+int Limit
}
class HTTPMatchCondition {
+interface{} Method
+string Path
+string PathRegex
+map[string]string Query
+map[string]string Headers
+map[string]interface{} Body
+[]string IPWhitelist
}
Rule --> Response : "包含"
Response --> DelayConfig : "可选"
Rule --> HTTPMatchCondition : "匹配条件"
```

**图表来源**
- [models.go](file://internal/models/models.go#L48-L63)
- [models.go](file://internal/models/models.go#L77-L82)
- [models.go](file://internal/models/models.go#L84-L94)
- [models.go](file://internal/models/models.go#L66-L75)

#### 字段定义与约束

| 字段名 | 类型 | 约束条件 | 默认值 | 业务含义 |
|--------|------|----------|--------|----------|
| ID | string | 必填，MongoDB ObjectId | 自动生成 | 规则唯一标识符 |
| Name | string | 必填，非空 | - | 规则显示名称 |
| ProjectID | string | 必填，外键关联 | - | 所属项目ID |
| EnvironmentID | string | 必填，外键关联 | - | 所属环境ID |
| Protocol | ProtocolType | 枚举值 | HTTP | 协议类型 |
| MatchType | MatchType | 枚举值 | Simple | 匹配类型 |
| Priority | int | 必填，数值越大优先级越高 | 0 | 规则优先级 |
| Enabled | bool | 必填，默认为true | true | 规则启用状态 |
| MatchCondition | map[string]interface{} | 必填，动态结构 | {} | 匹配条件配置 |
| Response | Response | 必填 | - | 响应配置 |
| Tags | []string | 可选，数组 | [] | 规则标签 |
| Creator | string | 可选 | - | 创建者标识 |
| CreatedAt | time.Time | 自动设置 | 当前时间 | 创建时间 |
| UpdatedAt | time.Time | 自动更新 | 当前时间 | 最后更新时间 |

**节来源**
- [models.go](file://internal/models/models.go#L48-L63)

### Project（项目）模型

Project代表一个独立的Mock服务项目，具有完整的工作空间隔离能力。

```mermaid
classDiagram
class Project {
+string ID
+string Name
+string WorkspaceID
+string Description
+time.Time CreatedAt
+time.Time UpdatedAt
}
class Workspace {
+string ID
+string Name
+string Owner
+[]string Members
+map[string]interface{} Permissions
+time.Time CreatedAt
+time.Time UpdatedAt
}
Project --> Workspace : "属于"
```

**图表来源**
- [models.go](file://internal/models/models.go#L104-L112)
- [models.go](file://internal/models/models.go#L125-L134)

#### 字段定义与约束

| 字段名 | 类型 | 约束条件 | 默认值 | 业务含义 |
|--------|------|----------|--------|----------|
| ID | string | 必填，MongoDB ObjectId | 自动生成 | 项目唯一标识符 |
| Name | string | 必填，非空，唯一 | - | 项目名称 |
| WorkspaceID | string | 必填，外键关联 | - | 所属工作空间ID |
| Description | string | 可选 | - | 项目描述 |
| CreatedAt | time.Time | 自动设置 | 当前时间 | 创建时间 |
| UpdatedAt | time.Time | 自动更新 | 当前时间 | 最后更新时间 |

**节来源**
- [models.go](file://internal/models/models.go#L104-L112)

### Environment（环境）模型

Environment代表项目的不同部署环境，支持多环境配置管理。

```mermaid
classDiagram
class Environment {
+string ID
+string Name
+string ProjectID
+string BaseURL
+map[string]interface{} Variables
+time.Time CreatedAt
+time.Time UpdatedAt
}
class HTTPResponse {
+int StatusCode
+map[string]string Headers
+interface{} Body
+ContentType ContentType
}
Environment --> HTTPResponse : "配置"
```

**图表来源**
- [models.go](file://internal/models/models.go#L114-L123)
- [models.go](file://internal/models/models.go#L96-L102)

#### 字段定义与约束

| 字段名 | 类型 | 约束条件 | 默认值 | 业务含义 |
|--------|------|----------|--------|----------|
| ID | string | 必填，MongoDB ObjectId | 自动生成 | 环境唯一标识符 |
| Name | string | 必填，非空 | - | 环境名称 |
| ProjectID | string | 必填，外键关联 | - | 所属项目ID |
| BaseURL | string | 可选 | - | 基础URL |
| Variables | map[string]interface{} | 可选，动态配置 | {} | 环境变量 |
| CreatedAt | time.Time | 自动设置 | 当前时间 | 创建时间 |
| UpdatedAt | time.Time | 自动更新 | 当前时间 | 最后更新时间 |

**节来源**
- [models.go](file://internal/models/models.go#L114-L123)

## 集合映射关系

系统中的MongoDB集合与Go结构体之间通过BSON标签建立映射关系：

```mermaid
erDiagram
RULES {
string _id PK
string name
string project_id FK
string environment_id FK
string protocol
string match_type
int priority
bool enabled
object match_condition
object response
array tags
string creator
datetime created_at
datetime updated_at
}
PROJECTS {
string _id PK
string name UK
string workspace_id FK
string description
datetime created_at
datetime updated_at
}
ENVIRONMENTS {
string _id PK
string name
string project_id FK
string base_url
object variables
datetime created_at
datetime updated_at
}
LOGS {
string _id PK
string request_id
string project_id FK
string environment_id FK
string rule_id FK
string protocol
string method
string path
object request
object response
int status_code
int64 duration
string source_ip
datetime timestamp
}
VERSIONS {
string _id PK
string rule_id FK
string version
string change_type
object changes
string operator
string description
datetime created_at
}
USERS {
string _id PK
string username UK
string email UK
string password_hash
string role
datetime created_at
datetime updated_at
}
RULES ||--o{ ENVIRONMENTS : "belongs to"
PROJECTS ||--o{ RULES : "contains"
PROJECTS ||--o{ ENVIRONMENTS : "contains"
LOGS }o--|| RULES : "generated by"
VERSIONS }o--|| RULES : "tracks changes"
```

**图表来源**
- [models.go](file://internal/models/models.go#L48-L63)
- [models.go](file://internal/models/models.go#L104-L112)
- [models.go](file://internal/models/models.go#L114-L123)
- [database.go](file://internal/repository/database.go#L55-L146)

**节来源**
- [models.go](file://internal/models/models.go#L48-L176)
- [database.go](file://internal/repository/database.go#L55-L146)

## 索引设计

系统采用多层次索引策略优化查询性能：

### Rules集合索引

```mermaid
graph TD
A[rules集合] --> B[复合索引]
A --> C[单一字段索引]
B --> D["project_id + environment_id<br/>用于快速定位规则"]
C --> E["protocol<br/>协议类型查询"]
C --> F["enabled<br/>启用状态过滤"]
C --> G["priority<br/>优先级排序"]
C --> H["tags<br/>标签查询"]
C --> I["created_at<br/>时间范围查询"]
```

**图表来源**
- [database.go](file://internal/repository/database.go#L56-L79)

#### Rules集合索引详情

| 索引类型 | 字段组合 | 用途 | 性能影响 |
|----------|----------|------|----------|
| 复合索引 | project_id + environment_id | 快速定位特定环境规则 | O(log n) |
| 单字段索引 | protocol | 协议类型过滤查询 | O(log n) |
| 单字段索引 | enabled | 启用状态过滤 | O(log n) |
| 单字段索引 | priority | 优先级排序 | O(log n) |
| 单字段索引 | tags | 标签查询 | O(log n) |
| 单字段索引 | created_at | 时间范围查询 | O(log n) |

**节来源**
- [database.go](file://internal/repository/database.go#L56-L79)

### Projects集合索引

```mermaid
graph TD
A[projects集合] --> B[单一字段索引]
B --> C["workspace_id<br/>工作空间查询"]
```

**图表来源**
- [database.go](file://internal/repository/database.go#L84-L91)

#### Projects集合索引详情

| 索引类型 | 字段 | 用途 | 性能影响 |
|----------|------|------|----------|
| 单字段索引 | workspace_id | 工作空间内项目查询 | O(log n) |

**节来源**
- [database.go](file://internal/repository/database.go#L84-L91)

### Environments集合索引

```mermaid
graph TD
A[environments集合] --> B[单一字段索引]
B --> C["project_id<br/>项目内环境查询"]
```

**图表来源**
- [database.go](file://internal/repository/database.go#L95-L102)

#### Environments集合索引详情

| 索引类型 | 字段 | 用途 | 性能影响 |
|----------|------|------|----------|
| 单字段索引 | project_id | 项目内环境查询 | O(log n) |

**节来源**
- [database.go](file://internal/repository/database.go#L95-L102)

### Logs集合索引（带TTL）

```mermaid
graph TD
A[logs集合] --> B[复合索引]
A --> C[TTL索引]
B --> D["request_id<br/>请求追踪"]
B --> E["rule_id<br/>规则匹配"]
B --> F["protocol<br/>协议过滤"]
B --> G["project_id + environment_id<br/>项目环境查询"]
C --> H["timestamp<br/>自动过期删除<br/>7天TTL"]
```

**图表来源**
- [database.go](file://internal/repository/database.go#L106-L129)

#### Logs集合索引详情

| 索引类型 | 字段组合 | 用途 | TTL设置 |
|----------|----------|------|---------|
| 单字段索引 | request_id | 请求追踪 | 无 |
| 单字段索引 | rule_id | 规则匹配 | 无 |
| 单字段索引 | protocol | 协议过滤 | 无 |
| 复合索引 | project_id + environment_id | 项目环境查询 | 无 |
| TTL索引 | timestamp | 自动过期删除 | 7天 |

**节来源**
- [database.go](file://internal/repository/database.go#L106-L129)

### Users集合索引

```mermaid
graph TD
A[users集合] --> B[唯一索引]
B --> C["username<br/>用户名唯一"]
B --> D["email<br/>邮箱唯一"]
```

**图表来源**
- [database.go](file://internal/repository/database.go#L148-L162)

#### Users集合索引详情

| 索引类型 | 字段 | 用途 | 唯一性 |
|----------|------|------|--------|
| 唯一索引 | username | 用户名唯一性 | 是 |
| 唯一索引 | email | 邮箱唯一性 | 是 |

**节来源**
- [database.go](file://internal/repository/database.go#L148-L162)

## 数据生命周期管理

### 规则启用状态持久化

系统通过`Enabled`字段实现规则的启用状态持久化：

```mermaid
stateDiagram-v2
[*] --> Disabled : 创建规则
Disabled --> Enabled : 启用规则
Enabled --> Disabled : 禁用规则
Enabled --> [*] : 删除规则
Disabled --> [*] : 删除规则
note right of Enabled : 规则参与匹配引擎计算
note left of Disabled : 规则被忽略，不参与匹配
```

**图表来源**
- [models.go](file://internal/models/models.go#L56)

#### 启用状态管理特性

| 状态 | 字段值 | 匹配行为 | 查询优化 |
|------|--------|----------|----------|
| 启用 | true | 参与匹配计算 | enabled=true过滤 |
| 禁用 | false | 忽略不匹配 | enabled=false过滤 |

**节来源**
- [models.go](file://internal/models/models.go#L56)
- [rule_repository.go](file://internal/repository/rule_repository.go#L140-L161)

### 时间戳自动管理

所有核心实体都实现了自动时间戳管理：

```mermaid
sequenceDiagram
participant Client as 客户端
participant Handler as API处理器
participant Repo as 仓储层
participant DB as MongoDB
Client->>Handler : 创建请求
Handler->>Handler : 设置CreatedAt=当前时间
Handler->>Handler : 设置UpdatedAt=当前时间
Handler->>Repo : Create(rule)
Repo->>Repo : 设置CreatedAt=当前时间
Repo->>Repo : 设置UpdatedAt=当前时间
Repo->>DB : 插入文档
DB-->>Repo : 返回结果
Repo-->>Handler : 返回结果
Handler-->>Client : 返回创建的规则
```

**图表来源**
- [project_repository.go](file://internal/repository/project_repository.go#L36-L49)
- [rule_repository.go](file://internal/repository/rule_repository.go#L36-L49)

**节来源**
- [project_repository.go](file://internal/repository/project_repository.go#L36-L49)
- [rule_repository.go](file://internal/repository/rule_repository.go#L36-L49)

## 项目级别数据隔离

### 工作空间隔离机制

系统通过工作空间（Workspace）实现项目级别的数据隔离：

```mermaid
graph TB
subgraph "工作空间A"
A1[项目1]
A2[项目2]
A3[项目3]
A1 --> A1E1[环境1]
A1 --> A1E2[环境2]
A2 --> A2E1[环境1]
A3 --> A3E1[环境1]
end
subgraph "工作空间B"
B1[项目4]
B2[项目5]
B1 --> B1E1[环境1]
B2 --> B2E1[环境1]
end
subgraph "全局资源"
U1[用户管理]
U2[系统配置]
end
```

**图表来源**
- [models.go](file://internal/models/models.go#L125-L134)
- [project_repository.go](file://internal/repository/project_repository.go#L108-L122)

### 项目间数据隔离策略

| 隔离层级 | 隔离机制 | 实现方式 | 访问控制 |
|----------|----------|----------|----------|
| 工作空间级别 | WorkspaceID外键 | Project.WorkspaceID | 工作空间权限检查 |
| 项目级别 | ProjectID外键 | Rule.ProjectID, Environment.ProjectID | 项目成员权限 |
| 环境级别 | EnvironmentID外键 | Rule.EnvironmentID | 环境访问权限 |

**节来源**
- [models.go](file://internal/models/models.go#L107)
- [models.go](file://internal/models/models.go#L118)
- [models.go](file://internal/models/models.go#L51)

### 环境隔离机制

环境作为项目的子集，提供更细粒度的配置隔离：

```mermaid
flowchart TD
A[项目] --> B[开发环境]
A --> C[测试环境]
A --> D[生产环境]
B --> E[开发专用配置]
C --> F[测试专用配置]
D --> G[生产专用配置]
E --> H[IP白名单：开发IP]
F --> I[IP白名单：测试IP]
G --> J[IP白名单：生产IP]
```

**图表来源**
- [models.go](file://internal/models/models.go#L114-L123)

**节来源**
- [models.go](file://internal/models/models.go#L114-L123)

## 数据访问模式

### 仓储模式实现

系统采用仓储模式封装数据访问逻辑：

```mermaid
classDiagram
class ProjectRepository {
<<interface>>
+Create(ctx, project) error
+Update(ctx, project) error
+Delete(ctx, id) error
+FindByID(ctx, id) Project
+FindByWorkspace(ctx, workspaceID) []Project
+List(ctx, skip, limit) []Project, int64, error
}
class RuleRepository {
<<interface>>
+Create(ctx, rule) error
+Update(ctx, rule) error
+Delete(ctx, id) error
+FindByID(ctx, id) Rule
+FindByEnvironment(ctx, projectID, environmentID) []Rule
+FindEnabledByEnvironment(ctx, projectID, environmentID) []Rule
+List(ctx, filter, skip, limit) []Rule, int64, error
}
class EnvironmentRepository {
<<interface>>
+Create(ctx, environment) error
+Update(ctx, environment) error
+Delete(ctx, id) error
+FindByID(ctx, id) Environment
+FindByProject(ctx, projectID) []Environment
}
class projectRepository {
+collection *mongo.Collection
+Create(ctx, project) error
+Update(ctx, project) error
+Delete(ctx, id) error
+FindByID(ctx, id) Project
+FindByWorkspace(ctx, workspaceID) []Project
+List(ctx, skip, limit) []Project, int64, error
}
class ruleRepository {
+collection *mongo.Collection
+Create(ctx, rule) error
+Update(ctx, rule) error
+Delete(ctx, id) error
+FindByID(ctx, id) Rule
+FindByEnvironment(ctx, projectID, environmentID) []Rule
+FindEnabledByEnvironment(ctx, projectID, environmentID) []Rule
+List(ctx, filter, skip, limit) []Rule, int64, error
}
class environmentRepository {
+collection *mongo.Collection
+Create(ctx, environment) error
+Update(ctx, environment) error
+Delete(ctx, id) error
+FindByID(ctx, id) Environment
+FindByProject(ctx, projectID) []Environment
}
ProjectRepository <|.. projectRepository
RuleRepository <|.. ruleRepository
EnvironmentRepository <|.. environmentRepository
```

**图表来源**
- [project_repository.go](file://internal/repository/project_repository.go#L14-L22)
- [rule_repository.go](file://internal/repository/rule_repository.go#L14-L23)
- [project_repository.go](file://internal/repository/project_repository.go#L24-L33)
- [rule_repository.go](file://internal/repository/rule_repository.go#L25-L34)

### ORM映射实现

系统使用MongoDB Go Driver进行ORM映射：

```mermaid
sequenceDiagram
participant Model as Go结构体
participant BSON as BSON标签
participant Driver as MongoDB Driver
participant DB as MongoDB
Model->>BSON : 定义bson标签
BSON->>Driver : 序列化/反序列化
Driver->>DB : 执行CRUD操作
DB-->>Driver : 返回结果
Driver-->>BSON : 转换数据类型
BSON-->>Model : 返回结构体
```

**图表来源**
- [models.go](file://internal/models/models.go#L48-L63)
- [project_repository.go](file://internal/repository/project_repository.go#L36-L49)

**节来源**
- [project_repository.go](file://internal/repository/project_repository.go#L14-L22)
- [rule_repository.go](file://internal/repository/rule_repository.go#L14-L23)

## 查询性能考量

### 查询优化策略

#### 1. 复合索引优化

系统针对常见查询模式设计复合索引：

```mermaid
graph LR
A[查询场景] --> B[规则查询]
A --> C[项目查询]
A --> D[环境查询]
B --> E["project_id + environment_id<br/>+ protocol + enabled"]
C --> F["workspace_id"]
D --> G["project_id"]
E --> H[高效范围查询]
F --> I[快速工作空间定位]
G --> J[快速项目定位]
```

**图表来源**
- [database.go](file://internal/repository/database.go#L56-L102)

#### 2. 分页查询优化

系统支持高效的分页查询：

| 查询类型 | 优化策略 | 性能特点 | 适用场景 |
|----------|----------|----------|----------|
| 规则列表 | skip+limit+createdAt排序 | O(log n + k) | 大数据量分页 |
| 项目列表 | skip+limit+createdAt排序 | O(log n + k) | 项目浏览 |
| 环境查询 | 直接ID查询 | O(log n) | 单条查询 |
| 启用规则 | enabled=true过滤 | O(log n + k) | 性能优化 |

**节来源**
- [rule_repository.go](file://internal/repository/rule_repository.go#L164-L195)
- [project_repository.go](file://internal/repository/project_repository.go#L126-L153)

#### 3. TTL索引优化

日志集合使用TTL索引自动清理过期数据：

```mermaid
flowchart TD
A[MongoDB TTL机制] --> B[自动删除]
B --> C[7天过期]
C --> D[后台任务执行]
D --> E[定期清理]
F[监控指标] --> G[存储使用率]
F --> H[删除效率]
F --> I[查询性能]
```

**图表来源**
- [database.go](file://internal/repository/database.go#L106-L129)

**节来源**
- [database.go](file://internal/repository/database.go#L106-L129)

### 查询模式分析

#### 常见查询模式

| 查询模式 | 索引使用 | 性能等级 | 优化建议 |
|----------|----------|----------|----------|
| 按ID查询 | _id索引 | O(log n) | 使用ObjectId查询 |
| 按项目查询 | project_id索引 | O(log n) | 使用复合索引 |
| 按环境查询 | environment_id索引 | O(log n) | 使用复合索引 |
| 按启用状态查询 | enabled索引 | O(log n) | 启用状态过滤 |
| 按优先级排序 | priority索引 | O(n log n) | 排序优化 |

**节来源**
- [rule_repository.go](file://internal/repository/rule_repository.go#L116-L161)

## 错误处理机制

### 错误分类体系

系统建立了完整的错误分类体系：

```mermaid
graph TD
A[错误分类] --> B[通用错误 1000-1999]
A --> C[项目相关 2000-2999]
A --> D[环境相关 3000-3999]
A --> E[规则相关 4000-4999]
A --> F[数据库相关 5000-5999]
A --> G[批量操作 6000-6999]
A --> H[导入导出 7000-7999]
A --> I[系统错误 9000-9999]
B --> B1[无效参数]
B --> B2[未授权]
B --> B3[请求过于频繁]
C --> C1[项目不存在]
C --> C2[项目已存在]
C --> C3[创建项目失败]
D --> D1[环境不存在]
D --> D2[环境已存在]
D --> D3[创建环境失败]
E --> E1[规则不存在]
E --> E2[未找到匹配规则]
E --> E3[创建规则失败]
```

**图表来源**
- [errors.go](file://internal/models/errors.go#L30-L213)

### 错误响应格式

系统提供标准化的错误响应格式：

| 字段名 | 类型 | 用途 | 示例 |
|--------|------|------|------|
| code | int | 错误码 | 4001 |
| message | string | 英文错误信息 | "Rule not found" |
| details | string | 详细错误信息 | "Rule with ID xxx not found" |
| request_id | string | 请求跟踪ID | "req-123456" |

**节来源**
- [errors.go](file://internal/models/errors.go#L18-L28)
- [errors.go](file://internal/models/errors.go#L190-L213)

## 总结

Go Mock Server的数据模型设计体现了以下核心原则：

### 设计优势

1. **层次化数据结构**：通过Project-Environment-Rule的三层结构实现清晰的组织关系
2. **灵活的匹配机制**：Rule模型支持多种匹配类型和复杂的匹配条件
3. **高性能查询**：精心设计的复合索引和查询优化策略
4. **完善的生命周期管理**：自动时间戳和状态持久化机制
5. **强隔离性**：工作空间和项目级别的数据隔离

### 性能特点

- **查询优化**：复合索引支持复杂查询场景
- **存储优化**：TTL索引自动清理历史数据
- **并发安全**：MongoDB的ACID特性保证数据一致性
- **扩展性**：模块化的仓储模式支持水平扩展

### 应用场景

该数据模型特别适用于：
- 微服务Mock服务
- API测试环境管理
- 多环境配置管理
- 团队协作的Mock服务治理

通过这套完整的数据模型，系统能够高效地支持Mock服务的核心功能需求，同时保持良好的性能和可维护性。