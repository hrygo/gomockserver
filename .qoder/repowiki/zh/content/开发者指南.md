# 开发者指南

<cite>
**本文档引用的文件**   
- [README.md](file://README.md)
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [Makefile](file://Makefile)
- [config.yaml](file://config.yaml)
- [config.test.yaml](file://config.test.yaml)
- [docker-compose.yml](file://docker-compose.yml)
- [docker-compose.test.yml](file://docker-compose.test.yml)
- [go.mod](file://go.mod)
- [internal/engine/match_engine.go](file://internal/engine/match_engine.go)
- [internal/api/project_handler.go](file://internal/api/project_handler.go)
- [internal/service/mock_service.go](file://internal/service/mock_service.go)
- [pkg/logger/logger.go](file://pkg/logger/logger.go)
- [tests/README.md](file://tests/README.md)
- [tests/integration/e2e_test.sh](file://tests/integration/e2e_test.sh)
</cite>

## 目录
1. [本地开发环境搭建](#本地开发环境搭建)
2. [代码风格规范](#代码风格规范)
3. [分支管理策略和PR提交流程](#分支管理策略和pr提交流程)
4. [Makefile关键命令说明](#makefile关键命令说明)
5. [添加新功能和编写测试用例](#添加新功能和编写测试用例)
6. [调试服务和调试技巧](#调试服务和调试技巧)
7. [依赖管理](#依赖管理)

## 本地开发环境搭建

本项目为贡献者提供了多种开发环境搭建方式，包括Docker Compose一键启动和手动启动两种模式，确保开发者能够快速上手。

### Docker Compose方式（推荐）

使用Docker Compose可以一键启动全栈应用，包括MongoDB数据库、后端服务和前端管理界面：

```bash
# 1. 克隆项目
git clone https://github.com/gomockserver/mockserver.git
cd mockserver

# 2. 启动全栈应用
make start-all

# 3. 停止所有服务
make stop-all
```

访问地址：
- **前端管理界面**: http://localhost:5173
- **后端管理API**: http://localhost:8080/api/v1
- **Mock服务API**: http://localhost:9090

### 手动启动方式

对于需要更精细控制的开发者，可以采用手动启动方式：

```bash
# 1. 安装依赖
go mod download
cd web/frontend && npm install && cd ..

# 2. 启动 MongoDB
make start-mongo

# 3. 启动后端服务
make start-backend

# 4. 启动前端（新终端）
make start-frontend
```

### 开发环境要求

- **Go 1.24+**: 项目使用Go 1.24版本进行开发
- **MongoDB 6.0+**: 作为主要数据存储
- **Node.js 18+**: 前端开发依赖
- **Docker & Docker Compose**: 用于容器化部署和测试

**Section sources**
- [README.md](file://README.md#L37-L86)
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L97-L122)
- [docker-compose.yml](file://docker-compose.yml#L1-L83)
- [docker-compose.test.yml](file://docker-compose.test.yml#L1-L126)

## 代码风格规范

本项目遵循Go语言的最佳实践和社区标准，确保代码质量和可维护性。

### Go代码规范

遵循 [Effective Go](https://golang.org/doc/effective_go.html) 和 [Go Code Review Comments](https://github.com/golang/go/wiki/CodeReviewComments) 指南：

1. **格式化**: 使用 `gofmt` 或 `goimports` 进行代码格式化
2. **命名规范**:
   - 包名：小写，简短，不使用下划线或驼峰
   - 导出标识符：使用大驼峰（PascalCase）
   - 非导出标识符：使用小驼峰（camelCase）
   - 常量：根据作用域使用大驼峰或小驼峰
3. **注释规范**:
   - 所有导出的函数、类型都应有注释
   - 注释以名称开头
   - 使用完整的句子
4. **错误处理**:
   - 不要忽略错误
   - 错误信息使用小写，不以标点结尾
   - 使用 `fmt.Errorf` 包装错误
5. **并发**: 注意goroutine泄漏和数据竞争

### 代码质量检查

在提交代码前，必须运行以下检查：

```bash
# 代码格式化
make fmt

# 代码检查
make lint

# 运行测试
make test
```

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L169-L210)
- [Makefile](file://Makefile#L269-L314)

## 分支管理策略和PR提交流程

本项目采用标准的Git工作流，确保代码质量和协作效率。

### 分支管理策略

1. **主分支**: `main` 分支为稳定版本，仅通过PR合并
2. **开发分支**: `develop` 分支为集成分支，用于功能集成
3. **特性分支**: `feature/xxx` 分支用于开发新功能
4. **修复分支**: `fix/xxx` 分支用于修复Bug

### PR提交流程

1. Fork本仓库
2. 创建功能分支（`git checkout -b feature/amazing-feature`）
3. 编写代码并添加测试
4. 确保所有测试通过
5. 提交更改（`git commit -m 'Add some amazing feature'`）
6. 推送到分支（`git push origin feature/amazing-feature`）
7. 创建Pull Request

### Commit Message格式

使用 [Conventional Commits](https://www.conventionalcommits.org/) 规范：

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type 类型**:
- `feat`: 新功能
- `fix`: Bug修复
- `docs`: 文档更新
- `style`: 代码格式（不影响代码运行）
- `refactor`: 重构（既不是新功能也不是Bug修复）
- `perf`: 性能优化
- `test`: 测试相关
- `chore`: 构建过程或辅助工具的变动

**PR描述模板**:
```markdown
## 变更说明
简要描述本PR的变更内容

## 变更类型
- [ ] 新功能
- [ ] Bug修复
- [ ] 文档更新
- [ ] 性能优化
- [ ] 重构
- [ ] 测试
- [ ] 其他

## 相关Issue
Closes #issue_number

## 测试
说明如何测试这些变更

## 检查清单
- [ ] 代码遵循项目规范
- [ ] 已添加必要的测试
- [ ] 所有测试通过
- [ ] 已更新相关文档
- [ ] Commit消息符合规范
```

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L83-L353)

## Makefile关键命令说明

Makefile提供了丰富的命令，简化了开发、测试和部署流程。

### 构建命令

```bash
make build           # 编译后端二进制文件
make build-frontend  # 构建前端（npm run build）
make build-fullstack # 构建完整应用（前端+后端）
make install         # 安装到GOPATH/bin
make clean           # 清理构建产物
make build-platforms # 跨平台编译
```

### 测试命令

```bash
make test            # 运行所有测试
make test-unit       # 运行单元测试
make test-service    # 运行Service层测试
make test-api        # 运行API层测试
make test-repository # 运行Repository层测试
make test-integration # 运行集成测试
make test-e2e        # 运行端到端测试
make test-coverage   # 生成覆盖率报告
make test-coverage-check # 检查覆盖率门限 (70%)
make test-docker     # 在Docker环境中测试
make bench           # 运行性能基准测试
```

### 代码质量命令

```bash
make fmt             # 格式化代码
make vet             # 运行go vet
make lint            # 运行golangci-lint
make check           # 运行所有检查
make code-analysis   # 代码分析
make security        # 安全扫描
make qa              # 质量检查 (fmt+vet+lint+test)
make pre-push        # 推送前检查 (qa+integration)
make pre-commit      # 提交前检查
```

### Docker命令

```bash
make docker-build      # 构建后端Docker镜像
make docker-build-full # 构建完整Docker镜像（包含前端）
make docker-up         # 启动服务
make docker-down       # 停止服务
make docker-test       # Docker测试环境
make docker-logs       # 查看日志
```

### 运行命令

```bash
make run             # 本地运行后端
make dev             # 开发模式运行（带热重载）
make start-mongo     # 启动MongoDB容器
make stop-mongo      # 停止MongoDB容器
make mongo-shell     # 连接MongoDB Shell
make start-all       # 启动全栈应用 (MongoDB + Redis + 后端 + 前端)
make stop-all        # 停止全栈应用
make start-backend   # 后台运行（使用dev配置）
make start-frontend  # 前端运行
```

**Section sources**
- [Makefile](file://Makefile#L1-L857)
- [README.md](file://README.md#L169-L182)

## 添加新功能和编写测试用例

### 添加新功能流程

1. 创建特性分支
2. 实现新功能
3. 添加必要的测试用例
4. 确保代码遵循项目规范
5. 更新相关文档
6. 提交PR

### 单元测试要求

- 所有新功能必须包含单元测试
- 核心模块的覆盖率应 > 80%
- 测试文件命名：`*_test.go`
- 使用 `testify` 进行断言

**示例**:
```go
func TestMatchEngine_Match(t *testing.T) {
    tests := []struct {
        name    string
        rule    *models.Rule
        request *adapter.Request
        want    bool
    }{
        {
            name: "精确路径匹配",
            rule: &models.Rule{
                MatchCondition: models.MatchCondition{
                    Method: "GET",
                    Path:   "/api/users",
                },
            },
            request: &adapter.Request{
                Method: "GET",
                Path:   "/api/users",
            },
            want: true,
        },
        // 更多测试用例...
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // 测试实现
            got := match(tt.rule, tt.request)
            assert.Equal(t, tt.want, got)
        })
    }
}
```

### 集成测试

- 测试完整的业务流程
- 使用Docker测试环境
- 测试文件放在 `tests/integration/`
- 包括基础功能测试、高级功能测试、WebSocket测试、压力测试等

### 性能测试

- 关键路径需要性能测试
- 使用Go benchmark或wrk
- 文档化性能基准
- 包括轻量级、中等负载、高负载和极高负载测试

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L227-L282)
- [tests/README.md](file://tests/README.md#L34-L357)
- [tests/integration/e2e_test.sh](file://tests/integration/e2e_test.sh#L1-L782)

## 调试服务和调试技巧

### 日志追踪

项目使用 `go.uber.org/zap` 作为日志库，支持多种日志级别和格式：

```go
// 日志初始化
logger.Init("info", "json", "stdout", "./logs/mockserver.log", 100, 10, 30)

// 日志使用
logger.Info("rule matched", 
    zap.String("rule_id", rule.ID),
    zap.String("rule_name", rule.Name))
```

配置文件中的日志配置：
```yaml
logging:
  level: "info" # debug, info, warn, error
  format: "json" # json, text
  output: "stdout" # stdout, file
  file:
    path: "./logs/mockserver.log"
    max_size: 100 # MB
    max_backups: 10
    max_age: 30 # days
```

### 断点调试

推荐使用以下IDE进行断点调试：

**VS Code**
- 推荐插件：
  - Go (golang.go)
  - Go Test Explorer
  - GitLens
  - MongoDB for VS Code

**GoLand**
- 内置完整的Go支持
- 集成测试运行器

### API请求跟踪

使用以下命令查看API请求和响应：

```bash
# 查看服务日志
tail -f /tmp/mockserver.log

# 查看MongoDB日志
make mongo-logs

# 查看Redis日志
make redis-logs

# 测试API端点
curl http://localhost:8080/api/v1/system/health
curl http://localhost:9090/PROJECT_ID/ENV_ID/api/users
```

### 调试技巧

1. **查看详细日志**:
```bash
DEBUG=1 ./tests/integration/run_all_e2e_tests.sh
```

2. **单步调试**:
```bash
# 运行单个测试
./tests/integration/e2e_test.sh

# 跳过服务器启动
SKIP_SERVER_START=true ./tests/integration/e2e_test.sh
```

3. **环境检查**:
```bash
# 检查服务状态
curl http://localhost:8080/api/v1/system/health
curl http://localhost:9090/health
```

4. **端口冲突处理**:
```bash
# 检查端口占用
lsof -i :8080  # Admin API
lsof -i :9090  # Mock API

# 停止冲突服务
make stop-all
```

**Section sources**
- [pkg/logger/logger.go](file://pkg/logger/logger.go#L1-L116)
- [config.yaml](file://config.yaml#L48-L58)
- [tests/README.md](file://tests/README.md#L304-L324)

## 依赖管理

### Go模块管理

项目使用Go Modules进行依赖管理，相关命令如下：

```bash
# 安装依赖
make deps

# 检查依赖
make deps-check

# 更新依赖
make deps-update

# 检查依赖升级
make deps-upgrade
```

go.mod文件内容：
```go
module github.com/gomockserver/mockserver

go 1.24.0

require (
	github.com/dop251/goja v0.0.0-20251103141225-af2ceb9156d7
	github.com/gin-contrib/cors v1.7.6
	github.com/gin-gonic/gin v1.11.0
	github.com/go-redis/redis/v8 v8.11.5
	github.com/google/uuid v1.6.0
	github.com/gorilla/websocket v1.5.3
	github.com/prometheus/client_golang v1.23.2
	github.com/redis/go-redis/v9 v9.16.0
	github.com/spf13/viper v1.21.0
	github.com/stretchr/testify v1.11.1
	github.com/vektah/gqlparser/v2 v2.5.1
	go.mongodb.org/mongo-driver v1.17.6
	go.uber.org/zap v1.27.0
	gopkg.in/natefinch/lumberjack.v2 v2.2.1
)
```

### 第三方库升级流程

1. 检查依赖升级：
```bash
make deps-upgrade
```

2. 更新依赖：
```bash
make deps-update
```

3. 验证依赖：
```bash
make deps-check
```

4. 运行测试确保兼容性：
```bash
make test-all
```

### 依赖管理最佳实践

1. **定期检查依赖更新**：使用 `make deps-upgrade` 定期检查依赖是否有新版本
2. **及时更新安全依赖**：特别是安全相关的库，应及时更新到最新版本
3. **测试兼容性**：更新依赖后，必须运行完整的测试套件确保兼容性
4. **记录变更**：在PR描述中记录依赖变更的原因和影响

**Section sources**
- [go.mod](file://go.mod#L1-L89)
- [Makefile](file://Makefile#L584-L603)
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L337-L342)