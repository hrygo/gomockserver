# 数据库连接配置

<cite>
**本文档引用的文件**
- [internal/config/config.go](file://internal/config/config.go)
- [config.yaml](file://config.yaml)
- [config.test.yaml](file://config.test.yaml)
- [internal/repository/database.go](file://internal/repository/database.go)
- [internal/config/config_test.go](file://internal/config/config_test.go)
- [internal/repository/repository_real_test.go](file://internal/repository/repository_real_test.go)
- [docker-compose.test.yml](file://docker-compose.test.yml)
- [tests/data/init-mongo.js](file://tests/data/init-mongo.js)
</cite>

## 目录
1. [简介](#简介)
2. [MongoDBConfig结构体详解](#mongodbconfig结构体详解)
3. [URI连接字符串配置](#uri连接字符串配置)
4. [Database字段配置](#database字段配置)
5. [Timeout设置机制](#timeout设置机制)
6. [连接池配置](#连接池配置)
7. [环境配置对比](#环境配置对比)
8. [连接初始化流程](#连接初始化流程)
9. [错误处理与故障排除](#错误处理与故障排除)
10. [最佳实践建议](#最佳实践建议)

## 简介

本文档详细介绍了GoMockServer项目中MongoDB数据库连接配置的核心组件，重点解析`MongoDBConfig`结构体的设计理念和配置方法。通过深入分析URI格式、Database字段、Timeout设置等关键配置项，帮助开发者理解和优化数据库连接策略。

## MongoDBConfig结构体详解

`MongoDBConfig`是数据库配置的核心结构体，包含了MongoDB连接所需的所有必要信息：

```mermaid
classDiagram
class MongoDBConfig {
+string URI
+string Database
+time.Duration Timeout
+ConnectionPool Pool
+validateURI() error
+getConnectionOptions() ClientOptions
}
class ConnectionPool {
+int Min
+int Max
+setPoolSize() uint64
}
class DatabaseConfig {
+MongoDB MongoDB
}
class Config {
+Database DatabaseConfig
+loadFromYAML() error
+validateConfig() error
}
MongoDBConfig --> ConnectionPool : "包含"
DatabaseConfig --> MongoDBConfig : "包含"
Config --> DatabaseConfig : "包含"
```

**图表来源**
- [internal/config/config.go](file://internal/config/config.go#L44-L50)

**章节来源**
- [internal/config/config.go](file://internal/config/config.go#L44-L50)

## URI连接字符串配置

### 标准格式规范

MongoDB URI遵循标准的连接字符串格式，支持多种认证和连接参数：

| 组件 | 格式 | 示例 | 说明 |
|------|------|------|------|
| 基础格式 | `mongodb://[username:password@]host1[:port1][,...hostN[:portN]][/[database][?options]]` | `mongodb://localhost:27017` | 最基本的连接格式 |
| 带认证格式 | `mongodb://[username:password@]host1[:port1][,...hostN[:portN]][/[database][?options]]` | `mongodb://user:pass@localhost:27017` | 包含用户名密码认证 |
| 复制集格式 | `mongodb://[username:password@]host1[:port1][,...hostN[:portN]]/database?replicaSet=name&authSource=admin` | `mongodb://user:pass@host1:27017,host2:27017/mydb?replicaSet=rs0&authSource=admin` | 支持复制集连接 |

### 支持的连接参数

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `replicaSet` | string | - | 指定复制集名称 |
| `authSource` | string | admin | 认证数据库 |
| `authMechanism` | string | SCRAM-SHA-1 | 认证机制 |
| `ssl` | boolean | false | 是否启用SSL连接 |
| `connectTimeoutMS` | int | 10000 | 连接超时时间（毫秒） |
| `socketTimeoutMS` | int | 180000 | 套接字超时时间（毫秒） |
| `serverSelectionTimeoutMS` | int | 30000 | 服务器选择超时时间（毫秒） |
| `maxPoolSize` | int | 100 | 最大连接池大小 |
| `minPoolSize` | int | 10 | 最小连接池大小 |

### 实际配置示例

**生产环境配置：**
```yaml
database:
  mongodb:
    uri: "mongodb://user:secure_password@prod-mongodb:27017/myapp?replicaSet=rs0&authSource=admin&ssl=true"
    database: "myapp_production"
    timeout: 30s
    pool:
      min: 10
      max: 200
```

**开发环境配置：**
```yaml
database:
  mongodb:
    uri: "mongodb://localhost:27017"
    database: "mockserver_dev"
    timeout: 10s
    pool:
      min: 5
      max: 50
```

**章节来源**
- [config.yaml](file://config.yaml#L15-L19)
- [config.test.yaml](file://config.test.yaml#L15-L19)
- [internal/config/config_test.go](file://internal/config/config_test.go#L344-L348)

## Database字段配置

### 默认数据库指定

`Database`字段用于指定MongoDB连接的默认数据库名称。该字段决定了应用程序在没有明确指定数据库时使用的默认数据库：

```mermaid
flowchart TD
A["应用启动"] --> B["读取Database配置"]
B --> C{"Database字段存在?"}
C --> |是| D["使用指定数据库"]
C --> |否| E["使用默认数据库"]
D --> F["建立数据库连接"]
E --> F
F --> G["验证数据库可用性"]
G --> H["初始化集合索引"]
H --> I["连接建立成功"]
```

**图表来源**
- [internal/repository/database.go](file://internal/repository/database.go#L42-L44)

### 数据库命名规范

| 环境类型 | 数据库命名模式 | 示例 | 用途 |
|----------|----------------|------|------|
| 开发环境 | `{project}_dev` | `mockserver_dev` | 开发调试专用 |
| 测试环境 | `{project}_test` | `mockserver_test` | 单元测试和集成测试 |
| 预发布环境 | `{project}_staging` | `mockserver_staging` | 部署前验证 |
| 生产环境 | `{project}_{env}` | `mockserver_production` | 正式生产环境 |

**章节来源**
- [config.yaml](file://config.yaml#L17)
- [config.test.yaml](file://config.test.yaml#L17)

## Timeout设置机制

### 连接超时配置

`Timeout`字段控制整个数据库连接过程的超时时间，包括连接建立、认证和初始验证阶段：

```mermaid
sequenceDiagram
participant App as "应用程序"
participant Config as "配置系统"
participant Mongo as "MongoDB客户端"
participant Server as "MongoDB服务器"
App->>Config : 读取Timeout配置
Config-->>App : 返回超时时间(30s)
App->>Mongo : 创建上下文withTimeout(30s)
Mongo->>Server : 发起连接请求
Server-->>Mongo : 连接响应
Mongo->>Server : 执行Ping命令
Server-->>Mongo : Ping响应
Mongo-->>App : 连接成功
Note over App,Server : 如果超过30秒未完成，返回超时错误
```

**图表来源**
- [internal/repository/database.go](file://internal/repository/database.go#L21-L22)

### 超时配置层次

| 配置层级 | 默认值 | 可配置范围 | 说明 |
|----------|--------|------------|------|
| 全局连接超时 | 30s | 1s-300s | 整个连接过程的总超时时间 |
| 连接建立超时 | 10s | 1s-60s | 建立TCP连接的超时时间 |
| 认证超时 | 5s | 1s-30s | 用户认证过程的超时时间 |
| 初始验证超时 | 5s | 1s-30s | Ping命令验证的超时时间 |

### 超时配置示例

```yaml
# 生产环境推荐配置
database:
  mongodb:
    timeout: 30s  # 全局连接超时

# 测试环境配置
database:
  mongodb:
    timeout: 10s  # 较短的超时时间用于快速失败
```

**章节来源**
- [config.yaml](file://config.yaml#L18)
- [config.test.yaml](file://config.test.yaml#L18)

## 连接池配置

### 连接池参数说明

连接池配置通过`ConnectionPool`结构体管理，控制MongoDB客户端的连接池行为：

```mermaid
classDiagram
class ConnectionPool {
+int Min
+int Max
+validatePoolSize() error
+calculatePoolRatio() float64
}
class MongoDBConfig {
+ConnectionPool Pool
+SetMinPoolSize(uint64) ClientOptions
+SetMaxPoolSize(uint64) ClientOptions
}
class MongoClient {
+Connect(ClientOptions) error
+Ping(Context) error
+Disconnect(Context) error
}
MongoDBConfig --> ConnectionPool : "包含"
MongoClient --> MongoDBConfig : "使用"
```

**图表来源**
- [internal/config/config.go](file://internal/config/config.go#L52-L56)
- [internal/repository/database.go](file://internal/repository/database.go#L26-L28)

### 连接池配置表

| 参数 | 推荐值 | 最小值 | 最大值 | 说明 |
|------|--------|--------|--------|------|
| `min` | CPU核心数×2 | 1 | 50 | 最小保持连接数 |
| `max` | CPU核心数×10 | 10 | 500 | 最大连接数限制 |
| `ratio` | 5:1 | 1:1 | 10:1 | 最大/最小连接数比例 |

### 环境差异化配置

**生产环境：**
```yaml
database:
  mongodb:
    pool:
      min: 20  # CPU核心数×2
      max: 200 # CPU核心数×10
```

**测试环境：**
```yaml
database:
  mongodb:
    pool:
      min: 5   # 较少连接用于资源节约
      max: 50  # 适中的最大连接数
```

**章节来源**
- [config.yaml](file://config.yaml#L19-L22)
- [config.test.yaml](file://config.test.yaml#L19-L22)

## 环境配置对比

### 配置差异分析

不同环境下的MongoDB配置存在显著差异，主要体现在连接参数、性能调优和安全性考虑：

| 配置项 | 开发环境 | 测试环境 | 生产环境 |
|--------|----------|----------|----------|
| URI | `mongodb://localhost:27017` | `mongodb://mongodb-test:27017` | `mongodb://user:pass@prod-mongodb:27017` |
| Database | `mockserver_dev` | `mockserver_test` | `mockserver_production` |
| Timeout | 10s | 10s | 30s |
| Min Pool Size | 5 | 5 | 20 |
| Max Pool Size | 50 | 50 | 200 |
| SSL | false | false | true |
| Authentication | 无 | 无 | 有 |

### Docker环境配置

在Docker容器环境中，MongoDB连接配置需要考虑网络隔离和容器间通信：

```yaml
# Docker测试环境配置
database:
  mongodb:
    uri: "mongodb://mongodb-test:27017"
    database: "mockserver_test"
    timeout: 10s
    pool:
      min: 5
      max: 50
```

**章节来源**
- [config.yaml](file://config.yaml#L15-L19)
- [config.test.yaml](file://config.test.yaml#L15-L19)
- [docker-compose.test.yml](file://docker-compose.test.yml#L8-L17)

## 连接初始化流程

### 初始化步骤详解

数据库连接的初始化过程经过精心设计，确保连接的可靠性和性能：

```mermaid
flowchart TD
A["开始初始化"] --> B["创建带超时的上下文"]
B --> C["构建客户端选项"]
C --> D["应用URI配置"]
D --> E["设置连接池参数"]
E --> F["尝试建立连接"]
F --> G{"连接成功?"}
G --> |否| H["返回连接错误"]
G --> |是| I["执行Ping验证"]
I --> J{"Ping成功?"}
J --> |否| K["返回Ping错误"]
J --> |是| L["获取数据库实例"]
L --> M["创建集合索引"]
M --> N{"索引创建成功?"}
N --> |否| O["返回索引错误"]
N --> |是| P["初始化完成"]
H --> Q["清理资源"]
K --> Q
O --> Q
Q --> R["返回错误"]
P --> S["返回成功"]
```

**图表来源**
- [internal/repository/database.go](file://internal/repository/database.go#L19-L50)

### 错误处理机制

连接过程中可能出现的错误类型及处理策略：

| 错误类型 | 常见原因 | 处理策略 | 解决方案 |
|----------|----------|----------|----------|
| 连接超时 | 网络延迟、服务器负载 | 返回超时错误 | 增加超时时间或检查网络 |
| 认证失败 | 用户名密码错误 | 返回认证错误 | 检查凭据配置 |
| 数据库不存在 | 数据库名称错误 | 返回数据库错误 | 验证数据库名称 |
| 权限不足 | 用户权限不够 | 返回权限错误 | 检查用户权限设置 |

**章节来源**
- [internal/repository/database.go](file://internal/repository/database.go#L32-L48)

## 错误处理与故障排除

### 常见连接问题

#### 主机不可达问题

**症状：**
- 连接超时错误
- DNS解析失败
- 网络不通

**排查步骤：**
1. 检查MongoDB服务是否运行：`docker ps | grep mongodb`
2. 验证网络连通性：`telnet mongodb-host 27017`
3. 检查防火墙设置：`iptables -L`

**解决方案：**
```bash
# 检查MongoDB服务状态
docker exec -it mongodb-test mongosh --eval "db.runCommand({ping: 1})"

# 测试网络连通性
telnet mongodb-host 27017
```

#### 端口阻塞问题

**症状：**
- 连接被拒绝
- 端口监听失败
- 无法建立TCP连接

**排查步骤：**
1. 检查端口占用：`netstat -tlnp | grep 27017`
2. 验证防火墙规则：`iptables -L`
3. 检查容器端口映射：`docker ps`

**解决方案：**
```yaml
# 修改端口配置
database:
  mongodb:
    uri: "mongodb://localhost:27018"  # 使用不同端口
```

#### 认证数据库错误

**症状：**
- 认证失败
- 权限不足
- 用户不存在

**排查步骤：**
1. 验证认证数据库：`db.getSiblingDB('admin').runCommand({connectionStatus: 1})`
2. 检查用户权限：`db.getUsers()`
3. 验证密码：`db.auth('username', 'password')`

**解决方案：**
```yaml
# 指定正确的认证数据库
database:
  mongodb:
    uri: "mongodb://user:pass@host:27017/mydb?authSource=admin"
```

### 连接诊断工具

#### 健康检查实现

```mermaid
sequenceDiagram
participant Health as "健康检查器"
participant Config as "配置系统"
participant Mongo as "MongoDB客户端"
participant DB as "MongoDB实例"
Health->>Config : 获取数据库配置
Config-->>Health : 返回连接信息
Health->>Mongo : 创建临时连接
Mongo->>DB : 执行Ping命令
DB-->>Mongo : 返回响应
Mongo-->>Health : 连接状态
Health->>Mongo : 关闭连接
Health-->>Health : 生成健康报告
```

**图表来源**
- [internal/service/health_test.go](file://internal/service/health_test.go#L55-L98)

#### 诊断命令集合

```bash
# 1. 检查MongoDB连接
mongosh "mongodb://user:pass@host:27017/db?authSource=admin" --eval "db.runCommand({ping: 1})"

# 2. 检查数据库状态
mongosh "mongodb://user:pass@host:27017/admin?authSource=admin" --eval "db.serverStatus()"

# 3. 检查集合索引
mongosh "mongodb://user:pass@host:27017/db?authSource=admin" --eval "db.collection('rules').getIndexes()"

# 4. 检查连接池状态
mongosh "mongodb://user:pass@host:27017/admin?authSource=admin" --eval "db.currentOp()"
```

**章节来源**
- [internal/repository/repository_real_test.go](file://internal/repository/repository_real_test.go#L25-L48)

## 最佳实践建议

### 生产环境配置建议

1. **安全性配置**
   - 使用强密码和加密连接
   - 配置适当的认证机制
   - 启用SSL/TLS加密传输

2. **性能优化**
   - 根据CPU核心数调整连接池大小
   - 设置合理的超时时间
   - 监控连接池使用率

3. **高可用性**
   - 配置复制集连接
   - 实施连接重试机制
   - 设置健康检查间隔

### 开发环境配置建议

1. **简化配置**
   - 使用本地MongoDB实例
   - 禁用SSL认证
   - 设置较短的超时时间

2. **调试友好**
   - 启用详细的日志记录
   - 使用专门的开发数据库
   - 配置自动重连机制

3. **资源节约**
   - 减少连接池大小
   - 使用较低的并发限制
   - 及时清理测试数据

### 监控和维护

1. **连接监控**
   - 监控连接池使用率
   - 跟踪连接失败率
   - 分析连接延迟分布

2. **性能调优**
   - 定期检查索引使用情况
   - 优化查询性能
   - 调整连接池参数

3. **故障预防**
   - 实施定期健康检查
   - 建立告警机制
   - 制定应急预案

通过遵循这些最佳实践，可以确保MongoDB连接的稳定性、安全性和高性能，为应用程序提供可靠的数据库服务支撑。