# 数据库配置

<cite>
**本文档引用的文件**
- [config.go](file://internal/config/config.go)
- [database.go](file://internal/repository/database.go)
- [config.yaml](file://config.yaml)
- [config.test.yaml](file://config.test.yaml)
- [config_test.go](file://internal/config/config_test.go)
- [docker-compose.yml](file://docker-compose.yml)
- [docker-compose.test.yml](file://docker-compose.test.yml)
</cite>

## 目录
1. [简介](#简介)
2. [配置结构概述](#配置结构概述)
3. [DatabaseConfig 结构详解](#databaseconfig-结构详解)
4. [MongoDBConfig 配置参数](#mongodbconfig-配置参数)
5. [连接池配置](#连接池配置)
6. [配置文件对比分析](#配置文件对比分析)
7. [初始化流程分析](#初始化流程分析)
8. [常见问题与解决方案](#常见问题与解决方案)
9. [最佳实践建议](#最佳实践建议)

## 简介

本文档详细介绍了 Gomockserver 项目中的数据库配置系统，重点关注 MongoDB 的配置参数、连接管理和性能优化策略。通过深入分析配置结构、初始化流程和实际应用场景，帮助开发者理解和优化数据库连接配置。

## 配置结构概述

系统采用分层配置架构，主要包含以下核心配置结构：

```mermaid
classDiagram
class Config {
+ServerConfig Server
+DatabaseConfig Database
+RedisConfig Redis
+SecurityConfig Security
+LoggingConfig Logging
+PerformanceConfig Performance
+FeaturesConfig Features
}
class DatabaseConfig {
+MongoDBConfig MongoDB
}
class MongoDBConfig {
+string URI
+string Database
+time.Duration Timeout
+ConnectionPool Pool
}
class ConnectionPool {
+int Min
+int Max
}
Config --> DatabaseConfig : "包含"
DatabaseConfig --> MongoDBConfig : "包含"
MongoDBConfig --> ConnectionPool : "包含"
```

**图表来源**
- [config.go](file://internal/config/config.go#L11-L56)

**章节来源**
- [config.go](file://internal/config/config.go#L11-L56)

## DatabaseConfig 结构详解

### 结构定义

DatabaseConfig 是数据库配置的顶层容器，专门负责管理 MongoDB 和其他数据库类型的配置：

```mermaid
classDiagram
class DatabaseConfig {
+MongoDBConfig MongoDB
}
class MongoDBConfig {
+string URI
+string Database
+time.Duration Timeout
+ConnectionPool Pool
}
class ConnectionPool {
+int Min
+int Max
}
DatabaseConfig --> MongoDBConfig : "嵌套"
MongoDBConfig --> ConnectionPool : "嵌套"
```

**图表来源**
- [config.go](file://internal/config/config.go#L39-L56)

### 核心特性

1. **模块化设计**：将 MongoDB 配置独立封装，便于扩展其他数据库类型
2. **类型安全**：使用强类型定义确保配置参数的正确性
3. **默认值支持**：通过零值机制提供合理的默认行为

**章节来源**
- [config.go](file://internal/config/config.go#L39-L56)

## MongoDBConfig 配置参数

### URI 连接字符串格式

MongoDB URI 支持多种连接格式，系统通过 Viper 自动解析：

| 参数类型 | 格式示例 | 说明 |
|---------|---------|------|
| 基础连接 | `mongodb://localhost:27017` | 主机名和端口 |
| 带认证 | `mongodb://user:pass@localhost:27017` | 用户名密码认证 |
| 复制集 | `mongodb://host1:27017,host2:27017/?replicaSet=myReplSet` | 复制集配置 |
| SSL/TLS | `mongodb://localhost:27017/?ssl=true` | 安全连接 |
| 数据库选择 | `mongodb://localhost:27017/mydatabase` | 直接指定数据库 |

### 数据库名称配置

- **作用**：指定应用程序连接的具体数据库实例
- **默认行为**：如果 URI 中未指定数据库，则需在配置中明确指定
- **命名规范**：推荐使用小写字母和下划线，避免特殊字符

### 超时设置

超时配置采用 Go 的 Duration 格式，支持多种时间单位：

| 配置项 | 类型 | 单位 | 推荐值 | 说明 |
|-------|------|------|--------|------|
| Timeout | time.Duration | 秒 | 10s | 连接建立超时 |
| database_query | time.Duration | 秒 | 10s | 数据库查询超时 |
| database_write | time.Duration | 秒 | 15s | 数据库写入超时 |
| health_check | time.Duration | 秒 | 2s | 健康检查超时 |

**章节来源**
- [config.go](file://internal/config/config.go#L44-L49)
- [config.yaml](file://config.yaml#L16-L18)

## 连接池配置

### 最小连接数 (Min)

- **作用**：维护的最小连接数量，确保系统启动时有可用连接
- **影响因素**：
  - 平均并发请求数
  - 响应时间要求
  - 系统负载模式
- **推荐策略**：
  - 生产环境：CPU核心数 × 2
  - 开发环境：2-5个连接

### 最大连接数 (Max)

- **作用**：连接池的最大容量限制
- **性能影响**：
  - 过小：可能导致连接等待，影响响应时间
  - 过大：增加内存消耗和数据库压力
- **计算公式**：最大连接数 = 并发用户数 × 平均响应时间 / 连接复用率

### 连接池管理流程

```mermaid
flowchart TD
Start([应用启动]) --> LoadConfig["加载配置<br/>Min: 10<br/>Max: 100"]
LoadConfig --> CreateClient["创建MongoDB客户端"]
CreateClient --> SetPool["设置连接池参数"]
SetPool --> Connect["尝试连接"]
Connect --> Success{"连接成功?"}
Success --> |是| PingTest["执行Ping测试"]
Success --> |否| Error["返回连接错误"]
PingTest --> CreateIndex["创建索引"]
CreateIndex --> Ready["服务就绪"]
Error --> Retry["重试机制"]
Retry --> Connect
```

**图表来源**
- [database.go](file://internal/repository/database.go#L19-L50)

**章节来源**
- [database.go](file://internal/repository/database.go#L24-L28)
- [config.yaml](file://config.yaml#L19-L21)

## 配置文件对比分析

### 生产环境配置 (config.yaml)

```yaml
database:
  mongodb:
    uri: "mongodb://mongodb:27017"
    database: "mockserver"
    timeout: 10s
    pool:
      min: 10
      max: 100
```

### 测试环境配置 (config.test.yaml)

```yaml
database:
  mongodb:
    uri: "mongodb://mongodb-test:27017"
    database: "mockserver_test"
    timeout: 10s
    pool:
      min: 5
      max: 50
```

### 配置差异对比表

| 配置项 | 生产环境 | 测试环境 | 差异说明 |
|-------|---------|---------|----------|
| URI | mongodb:27017 | mongodb-test:27017 | 使用不同的容器网络 |
| Database | mockserver | mockserver_test | 分离数据隔离 |
| Min Pool Size | 10 | 5 | 测试环境资源节约 |
| Max Pool Size | 100 | 50 | 测试环境资源节约 |
| Log Level | info | debug | 测试环境详细日志 |
| Rate Limit | enabled | disabled | 测试环境无限流 |

### 环境切换策略

```mermaid
flowchart LR
EnvCheck{环境检测} --> Prod["生产环境<br/>GO_ENV=production"]
EnvCheck --> Test["测试环境<br/>GO_ENV=test"]
EnvCheck --> Dev["开发环境<br/>GO_ENV=development"]
Prod --> ProdConfig["config.yaml<br/>高性能配置"]
Test --> TestConfig["config.test.yaml<br/>资源节约配置"]
Dev --> DevConfig["本地配置<br/>快速调试"]
```

**图表来源**
- [config.yaml](file://config.yaml#L1-L91)
- [config.test.yaml](file://config.test.yaml#L1-L80)

**章节来源**
- [config.yaml](file://config.yaml#L13-L22)
- [config.test.yaml](file://config.test.yaml#L13-L22)

## 初始化流程分析

### 配置加载机制

系统通过 Viper 实现配置文件的自动发现和加载：

```mermaid
sequenceDiagram
participant App as 应用程序
participant Viper as Viper配置管理器
participant FileSystem as 文件系统
participant Config as 配置结构
App->>Viper : Load(configPath)
Viper->>FileSystem : 查找配置文件
FileSystem-->>Viper : 返回文件路径
Viper->>FileSystem : 读取YAML文件
FileSystem-->>Viper : 返回配置内容
Viper->>Viper : AutomaticEnv() 自动环境变量
Viper->>Config : Unmarshal 解析配置
Config-->>App : 返回配置对象
```

**图表来源**
- [config.go](file://internal/config/config.go#L138-L167)

### 数据库初始化步骤

```mermaid
sequenceDiagram
participant Init as Init函数
participant Context as 上下文管理
participant Client as MongoDB客户端
participant DB as 数据库实例
participant Index as 索引创建
Init->>Context : WithTimeout(timeout)
Context-->>Init : 带超时的上下文
Init->>Client : ApplyURI(uri)
Init->>Client : SetMinPoolSize(min)
Init->>Client : SetMaxPoolSize(max)
Init->>Client : Connect(ctx, options)
Client-->>Init : 连接结果
Init->>Client : Ping(ctx, nil)
Client-->>Init : Ping结果
Init->>DB : Database(database)
Init->>Index : createIndexes(ctx)
Index-->>Init : 索引创建结果
Init-->>Init : 返回最终状态
```

**图表来源**
- [database.go](file://internal/repository/database.go#L19-L50)

### 错误处理机制

系统实现了多层次的错误处理：

1. **连接级错误**：连接失败、认证错误
2. **验证级错误**：Ping测试失败
3. **业务级错误**：索引创建失败

**章节来源**
- [database.go](file://internal/repository/database.go#L19-L50)
- [config.go](file://internal/config/config.go#L138-L167)

## 常见问题与解决方案

### 连接失败问题

#### 网络不通

**症状**：连接超时或无法建立连接
**原因分析**：
- MongoDB 服务未启动
- 网络防火墙阻止连接
- 容器网络配置错误

**解决方案**：
1. 检查 MongoDB 服务状态
2. 验证网络连通性
3. 检查容器网络配置

#### 认证错误

**症状**：认证失败，权限拒绝
**原因分析**：
- 用户名密码错误
- 数据库不存在
- 权限不足

**解决方案**：
1. 验证认证凭据
2. 检查数据库存在性
3. 确认用户权限配置

#### 连接池耗尽

**症状**：请求被拒绝，连接等待超时
**原因分析**：
- 连接池配置过小
- 连接泄漏
- 高并发访问

**解决方案**：
1. 调整连接池大小
2. 检查连接释放逻辑
3. 实现连接健康检查

### 性能优化建议

#### 连接池调优

```mermaid
flowchart TD
Monitor[监控连接使用情况] --> Analyze{分析瓶颈}
Analyze --> |连接不足| IncreasePool["增加连接池大小<br/>Min: CPU核心数×2<br/>Max: 并发数×2"]
Analyze --> |连接过多| DecreasePool["减少连接池大小<br/>Min: CPU核心数<br/>Max: 并发数"]
Analyze --> |连接泄漏| FixLeak["修复连接泄漏<br/>确保正确释放"]
IncreasePool --> Monitor
DecreasePool --> Monitor
FixLeak --> Monitor
```

#### 超时配置优化

| 场景 | 查询超时 | 写入超时 | 健康检查超时 |
|------|---------|---------|-------------|
| 高并发 | 5-10s | 10-15s | 1-2s |
| 中等并发 | 10-15s | 15-20s | 2-3s |
| 低并发 | 15-30s | 20-30s | 3-5s |

### 故障排除流程

```mermaid
flowchart TD
Problem[发现问题] --> CheckLogs["检查应用日志"]
CheckLogs --> ConnError{连接错误?}
ConnError --> |是| NetCheck["检查网络连接"]
ConnError --> |否| PermError{权限错误?}
NetCheck --> MongoStatus["检查MongoDB状态"]
MongoStatus --> RestartMongo["重启MongoDB服务"]
RestartMongo --> TestConn["测试连接"]
PermError --> |是| VerifyCreds["验证认证凭据"]
PermError --> |否| PoolError{连接池错误?}
VerifyCreds --> UpdateCreds["更新认证信息"]
UpdateCreds --> TestConn
PoolError --> |是| AdjustPool["调整连接池配置"]
PoolError --> |否| OtherError["其他错误"]
AdjustPool --> TestConn
TestConn --> Success{测试成功?}
Success --> |是| Resolve[问题解决]
Success --> |否| Escalate[升级处理]
```

**章节来源**
- [database.go](file://internal/repository/database.go#L32-L40)

## 最佳实践建议

### 配置管理

1. **环境分离**：为不同环境维护独立的配置文件
2. **敏感信息保护**：使用环境变量存储密码等敏感信息
3. **配置验证**：在应用启动时验证配置的有效性
4. **动态配置**：支持运行时配置更新

### 性能优化

1. **连接池调优**：根据实际负载调整连接池大小
2. **超时设置**：合理设置各类超时参数
3. **索引策略**：创建合适的索引提高查询性能
4. **监控告警**：建立数据库性能监控体系

### 安全考虑

1. **网络隔离**：将数据库部署在专用网络中
2. **访问控制**：实施严格的访问权限控制
3. **加密传输**：启用 TLS/SSL 加密连接
4. **定期备份**：建立完善的数据备份策略

### 监控和维护

1. **健康检查**：定期检查数据库连接状态
2. **性能监控**：监控查询性能和连接使用情况
3. **日志管理**：建立完善的日志记录和分析体系
4. **故障预案**：制定数据库故障应急处理方案

通过遵循这些最佳实践，可以确保数据库配置的稳定性、安全性和高性能，为应用系统的可靠运行提供坚实保障。