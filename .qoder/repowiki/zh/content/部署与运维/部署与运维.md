# éƒ¨ç½²ä¸è¿ç»´

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [Dockerfile](file://docker/Dockerfile)
- [docker-compose.yml](file://docker-compose.yml)
- [docker-compose.test.yml](file://docker-compose.test.yml)
- [DEPLOYMENT.md](file://DEPLOYMENT.md)
- [config.yaml](file://config.yaml)
- [config.test.yaml](file://config.test.yaml)
- [Makefile](file://Makefile)
- [pkg/logger/logger.go](file://pkg/logger/logger.go)
- [internal/service/health.go](file://internal/service/health.go)
- [internal/api/health_handler.go](file://internal/api/health_handler.go)
</cite>

## ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
3. [Docker é•œåƒæ„å»º](#docker-é•œåƒæ„å»º)
4. [å®¹å™¨ç¼–æ’](#å®¹å™¨ç¼–æ’)
5. [Kubernetes éƒ¨ç½²](#kubernetes-éƒ¨ç½²)
6. [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
7. [å¥åº·æ£€æŸ¥ä¸ç›‘æ§](#å¥åº·æ£€æŸ¥ä¸ç›‘æ§)
8. [æ—¥å¿—æ”¶é›†](#æ—¥å¿—æ”¶é›†)
9. [æ€§èƒ½ç›‘æ§](#æ€§èƒ½ç›‘æ§)
10. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
11. [ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ](#ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ)
12. [å‡çº§ä¸ç»´æŠ¤](#å‡çº§ä¸ç»´æŠ¤)

## æ¦‚è¿°

Mock Server æ˜¯ä¸€ä¸ªåŸºäº Go çš„é«˜æ€§èƒ½ Mock æœåŠ¡ï¼Œæ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼ä»¥æ»¡è¶³ä¸åŒç¯å¢ƒéœ€æ±‚ã€‚æœ¬æŒ‡å—æ¶µç›–äº†ä»å¼€å‘æµ‹è¯•åˆ°ç”Ÿäº§ç¯å¢ƒçš„å®Œæ•´éƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ Docker å®¹å™¨åŒ–ã€Kubernetes é›†ç¾¤éƒ¨ç½²ä»¥åŠä¼ ç»ŸæœåŠ¡å™¨éƒ¨ç½²ã€‚

### æ”¯æŒçš„éƒ¨ç½²æ–¹å¼

| éƒ¨ç½²æ–¹å¼ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ | æ¨èåº¦ |
|---------|---------|-------|--------|
| ğŸ³ Docker Compose | å¿«é€Ÿä½“éªŒã€å¼€å‘æµ‹è¯• | â­â­ | â­â­â­â­â­ |
| ğŸ—ï¸ æœ¬åœ°éƒ¨ç½² | å¼€å‘è°ƒè¯•ã€æºç å®šåˆ¶ | â­â­â­ | â­â­â­ |
| â˜¸ï¸ Kubernetes | ç”Ÿäº§ç¯å¢ƒã€é«˜å¯ç”¨ | â­â­â­â­ | â­â­â­â­ |
| ğŸ³ Docker å•å®¹å™¨ | ç‰¹å®šç¯å¢ƒã€å¾®æœåŠ¡ | â­â­ | â­â­â­ |

## éƒ¨ç½²æ¶æ„

Mock Server é‡‡ç”¨å¤šå±‚æ¶æ„è®¾è®¡ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•å’Œé«˜å¯ç”¨éƒ¨ç½²ï¼š

```mermaid
graph TB
subgraph "è´Ÿè½½å‡è¡¡å±‚"
LB[è´Ÿè½½å‡è¡¡å™¨<br/>Nginx/HAProxy]
end
subgraph "åº”ç”¨å±‚"
MS1[Mock Server å®ä¾‹ 1]
MS2[Mock Server å®ä¾‹ 2]
MS3[Mock Server å®ä¾‹ 3]
end
subgraph "ç¼“å­˜å±‚"
Redis[(Redis ç¼“å­˜é›†ç¾¤)]
end
subgraph "æ•°æ®å±‚"
Mongo1[(MongoDB ä¸»èŠ‚ç‚¹)]
Mongo2[(MongoDB ä»èŠ‚ç‚¹)]
Mongo3[(MongoDB ä»²è£èŠ‚ç‚¹)]
end
subgraph "ç›‘æ§å±‚"
Prometheus[Prometheus]
Grafana[Grafana]
Loki[Loki æ—¥å¿—èšåˆ]
end
LB --> MS1
LB --> MS2
LB --> MS3
MS1 --> Redis
MS2 --> Redis
MS3 --> Redis
MS1 --> Mongo1
MS2 --> Mongo1
MS3 --> Mongo1
Mongo1 --> Mongo2
Mongo1 --> Mongo3
MS1 --> Prometheus
MS2 --> Prometheus
MS3 --> Prometheus
MS1 --> Loki
MS2 --> Loki
MS3 --> Loki
```

**å›¾è¡¨æ¥æº**
- [docker-compose.yml](file://docker-compose.yml#L1-L83)
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L377-L550)

## Docker é•œåƒæ„å»º

### åŸºç¡€é•œåƒæ„å»º

é¡¹ç›®æä¾›äº†ä¸‰ç§ä¸åŒç”¨é€”çš„ Docker é•œåƒï¼š

#### 1. åç«¯æœåŠ¡é•œåƒ (Dockerfile)
é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„å•ä½“é•œåƒï¼ŒåŒ…å«å®Œæ•´çš„åç«¯æœåŠ¡ï¼š

```mermaid
flowchart TD
A["åŸºç¡€æ„å»ºé•œåƒ<br/>golang:alpine"] --> B["å¤åˆ¶ä¾èµ–æ–‡ä»¶<br/>go.mod, go.sum"]
B --> C["ä¸‹è½½ä¾èµ–<br/>go mod download"]
C --> D["å¤åˆ¶æºä»£ç <br/>å…¨éƒ¨é¡¹ç›®æ–‡ä»¶"]
D --> E["ç¼–è¯‘åº”ç”¨<br/>CGO_ENABLED=0"]
E --> F["è¿è¡Œæ—¶é•œåƒ<br/>alpine:latest"]
F --> G["å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶<br/>mockserver"]
G --> H["å¤åˆ¶é…ç½®æ–‡ä»¶<br/>config.yaml"]
H --> I["æš´éœ²ç«¯å£<br/>8080, 9090"]
I --> J["å¯åŠ¨å‘½ä»¤<br/>./mockserver"]
```

**å›¾è¡¨æ¥æº**
- [docker/Dockerfile](file://docker/Dockerfile#L1-L36)

#### 2. å…¨æ ˆé•œåƒ (Dockerfile.fullstack)
åŒ…å«å‰ç«¯å’Œåç«¯çš„å®Œæ•´é•œåƒï¼Œæ”¯æŒé™æ€æ–‡ä»¶æœåŠ¡ï¼š

```mermaid
flowchart TD
A["å‰ç«¯æ„å»ºé˜¶æ®µ"] --> B["Node.js ç¯å¢ƒ<br/>node:18-alpine"]
B --> C["å®‰è£…ä¾èµ–<br/>npm install"]
C --> D["æ„å»ºå‰ç«¯<br/>npm run build"]
E["åç«¯æ„å»ºé˜¶æ®µ"] --> F["Go ç¯å¢ƒ<br/>golang:1.21-alpine"]
F --> G["ç¼–è¯‘åº”ç”¨<br/>å¸¦ç‰ˆæœ¬ä¿¡æ¯"]
H["è¿è¡Œæ—¶é˜¶æ®µ"] --> I["Alpine åŸºç¡€é•œåƒ"]
I --> J["å¤åˆ¶å‰ç«¯äº§ç‰©<br/>dist ç›®å½•"]
J --> K["å¤åˆ¶åç«¯äºŒè¿›åˆ¶<br/>mockserver"]
K --> L["è®¾ç½®ç”¨æˆ·æƒé™<br/>mockserver ç”¨æˆ·"]
L --> M["å¥åº·æ£€æŸ¥<br/>wget å‘½ä»¤"]
```

**å›¾è¡¨æ¥æº**
- [docker/Dockerfile.fullstack](file://docker/Dockerfile.fullstack#L1-L121)

#### 3. æµ‹è¯•é•œåƒ (Dockerfile.test)
ä¸“ä¸º CI/CD å’Œæµ‹è¯•ç¯å¢ƒè®¾è®¡ï¼š

```mermaid
flowchart TD
A["æµ‹è¯•æ„å»ºé˜¶æ®µ"] --> B["Go ç¯å¢ƒ<br/>golang:alpine"]
B --> C["è°ƒè¯•æ„å»ºè¿‡ç¨‹<br/>è¯¦ç»†è¾“å‡º"]
C --> D["éªŒè¯æºç <br/>ls -la ./cmd/"]
D --> E["æ„å»ºåº”ç”¨<br/>æµ‹è¯•ç¯å¢ƒ"]
F["è¿è¡Œæ—¶é˜¶æ®µ"] --> G["Alpine åŸºç¡€é•œåƒ"]
G --> H["å®‰è£… curl å·¥å…·"]
H --> I["å¤åˆ¶æµ‹è¯•é…ç½®<br/>config.test.yaml"]
I --> J["å¯åŠ¨æµ‹è¯•æœåŠ¡"]
```

**å›¾è¡¨æ¥æº**
- [docker/Dockerfile.test](file://docker/Dockerfile.test#L1-L51)

### é•œåƒæ„å»ºå‘½ä»¤

ä½¿ç”¨ Makefile ç®€åŒ–æ„å»ºè¿‡ç¨‹ï¼š

```bash
# æ„å»ºåç«¯é•œåƒ
make docker-build

# æ„å»ºå…¨æ ˆé•œåƒ
make docker-build-full

# è‡ªå®šä¹‰æ ‡ç­¾æ„å»º
docker build -f docker/Dockerfile -t mockserver:v1.0.0 .
```

**ç« èŠ‚æ¥æº**
- [Makefile](file://Makefile#L347-L357)
- [docker/Dockerfile](file://docker/Dockerfile#L1-L36)
- [docker/Dockerfile.fullstack](file://docker/Dockerfile.fullstack#L1-L121)

## å®¹å™¨ç¼–æ’

### Docker Compose éƒ¨ç½²

Docker Compose æ˜¯æœ€ç®€å•å’Œæ¨èçš„éƒ¨ç½²æ–¹å¼ï¼Œé€‚åˆå¼€å‘æµ‹è¯•å’Œå¿«é€Ÿéƒ¨ç½²ã€‚

#### æœåŠ¡æ¶æ„

```mermaid
graph LR
subgraph "Mock Server ç»„ä»¶"
MS[Mock Server<br/>ç«¯å£: 8080, 9090]
end
subgraph "æ•°æ®åº“æœåŠ¡"
MongoDB[MongoDB<br/>ç«¯å£: 27017]
end
subgraph "ç¼“å­˜æœåŠ¡"
Redis[Redis<br/>ç«¯å£: 6379]
end
subgraph "ç½‘ç»œ"
Network[mockserver-network]
end
MS --> |å¥åº·æ£€æŸ¥| MongoDB
MS --> |å¥åº·æ£€æŸ¥| Redis
MongoDB --> |æ•°æ®å­˜å‚¨| MongoDB
Redis --> |ç¼“å­˜| MS
Network --> MS
Network --> MongoDB
Network --> Redis
```

**å›¾è¡¨æ¥æº**
- [docker-compose.yml](file://docker-compose.yml#L1-L83)

#### é…ç½®è¦ç‚¹

1. **ç¯å¢ƒå˜é‡è¦†ç›–**ï¼šé€šè¿‡ `environment` å­—æ®µè®¾ç½®
2. **æ•°æ®æŒä¹…åŒ–**ï¼šä½¿ç”¨ `volumes` æŒ‚è½½æ•°æ®å·
3. **å¥åº·æ£€æŸ¥**ï¼šå†…ç½®å¥åº·æ£€æŸ¥æœºåˆ¶
4. **æœåŠ¡ä¾èµ–**ï¼šé€šè¿‡ `depends_on` æ§åˆ¶å¯åŠ¨é¡ºåº

#### éƒ¨ç½²å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose stop

# å®Œå…¨æ¸…ç†
docker-compose down -v
```

### æµ‹è¯•ç¯å¢ƒé…ç½®

æµ‹è¯•ç¯å¢ƒä½¿ç”¨ç‹¬ç«‹çš„ compose æ–‡ä»¶ï¼Œæ”¯æŒå¤šç§æµ‹è¯•åœºæ™¯ï¼š

```mermaid
flowchart TD
A["æµ‹è¯•ç¯å¢ƒå¯åŠ¨"] --> B["MongoDB æµ‹è¯•å®ä¾‹<br/>ç«¯å£: 27018"]
A --> C["Mock Server æµ‹è¯•<br/>ç«¯å£: 8081"]
A --> D["Redis æµ‹è¯•å¯é€‰<br/>ç«¯å£: 6380"]
A --> E["æ€§èƒ½æµ‹è¯•å·¥å…·<br/>wrk"]
A --> F["æµ‹è¯•è¿è¡Œå™¨<br/>é›†æˆæµ‹è¯•"]
B --> G["æµ‹è¯•æ•°æ®åº“<br/>mockserver_test"]
C --> H["æµ‹è¯•é…ç½®<br/>config.test.yaml"]
D --> I["æµ‹è¯•ç¼“å­˜"]
E --> J["å‹åŠ›æµ‹è¯•"]
F --> K["ç«¯åˆ°ç«¯æµ‹è¯•"]
```

**å›¾è¡¨æ¥æº**
- [docker-compose.test.yml](file://docker-compose.test.yml#L1-L126)

**ç« èŠ‚æ¥æº**
- [docker-compose.yml](file://docker-compose.yml#L1-L83)
- [docker-compose.test.yml](file://docker-compose.test.yml#L1-L126)

## Kubernetes éƒ¨ç½²

### éƒ¨ç½²æ¶æ„

Kubernetes éƒ¨ç½²æä¾›é«˜å¯ç”¨æ€§å’Œå¼¹æ€§ä¼¸ç¼©èƒ½åŠ›ï¼š

```mermaid
graph TB
subgraph "å‘½åç©ºé—´: mockserver"
subgraph "StatefulSet"
MongoDB[MockServer MongoDB<br/>å‰¯æœ¬: 1]
end
subgraph "Deployment"
MockServer[MockServer Deployment<br/>å‰¯æœ¬: 3]
end
subgraph "Services"
AdminSvc[Admin Service<br/>LoadBalancer]
MockSvc[Mock Service<br/>LoadBalancer]
end
subgraph "ConfigMaps"
Config[ConfigMap<br/>é…ç½®æ–‡ä»¶]
end
subgraph "PersistentVolumes"
MongoPV[MongoDB æ•°æ®å·]
LogPV[æ—¥å¿—æ•°æ®å·]
end
end
AdminSvc --> MockServer
MockSvc --> MockServer
MockServer --> MongoDB
MockServer --> Config
MongoDB --> MongoPV
MockServer --> LogPV
```

**å›¾è¡¨æ¥æº**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L377-L550)

### é…ç½®æ¸…å•

#### 1. ConfigMap é…ç½®

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mockserver-config
data:
  config.yaml: |
    server:
      admin:
        host: "0.0.0.0"
        port: 8080
      mock:
        host: "0.0.0.0"
        port: 9090
    database:
      mongodb:
        uri: "mongodb://mongodb-service:27017"
        database: "mockserver"
        timeout: 10s
        pool:
          min: 10
          max: 100
    logging:
      level: "info"
      format: "json"
      output: "stdout"
```

#### 2. MongoDB StatefulSet

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
spec:
  serviceName: mongodb-service
  replicas: 1
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
      - name: mongodb
        image: mongo:6.0
        ports:
        - containerPort: 27017
        volumeMounts:
        - name: mongodb-data
          mountPath: /data/db
  volumeClaimTemplates:
  - metadata:
      name: mongodb-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 20Gi
```

#### 3. Mock Server Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mockserver
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mockserver
  template:
    metadata:
      labels:
        app: mockserver
    spec:
      containers:
      - name: mockserver
        image: mockserver:latest
        ports:
        - containerPort: 8080
          name: admin
        - containerPort: 9090
          name: mock
        volumeMounts:
        - name: config
          mountPath: /root/config.yaml
          subPath: config.yaml
        livenessProbe:
          httpGet:
            path: /api/v1/system/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/v1/system/health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: mockserver-config
```

### éƒ¨ç½²å‘½ä»¤

```bash
# åº”ç”¨é…ç½®
kubectl apply -f k8s/configmap.yaml
kubectl apply -f k8s/mongodb.yaml
kubectl apply -f k8s/mockserver.yaml

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl get pods
kubectl get services

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/mockserver
```

**ç« èŠ‚æ¥æº**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L377-L550)

## é…ç½®ç®¡ç†

### é…ç½®æ–‡ä»¶ç»“æ„

Mock Server ä½¿ç”¨ YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œæ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–ï¼š

```mermaid
graph TD
A[é…ç½®æ–‡ä»¶ config.yaml] --> B[æœåŠ¡å™¨é…ç½®]
A --> C[æ•°æ®åº“é…ç½®]
A --> D[Redis é…ç½®]
A --> E[å®‰å…¨é…ç½®]
A --> F[æ—¥å¿—é…ç½®]
A --> G[æ€§èƒ½é…ç½®]
A --> H[åŠŸèƒ½å¼€å…³]
B --> B1[ç®¡ç† API æœåŠ¡]
B --> B2[Mock æœåŠ¡]
C --> C1[MongoDB è¿æ¥]
C --> C2[è¿æ¥æ± é…ç½®]
D --> D1[Redis è¿æ¥]
D --> D2[ç¼“å­˜é…ç½®]
E --> E1[JWT é…ç½®]
E --> E2[API Key]
E --> E3[IP ç™½åå•]
F --> F1[æ—¥å¿—çº§åˆ«]
F --> F2[è¾“å‡ºæ ¼å¼]
F --> F3[æ–‡ä»¶è½®è½¬]
G --> G1[ç¼“å­˜ TTL]
G --> G2[é™æµé…ç½®]
G --> G3[è¶…æ—¶è®¾ç½®]
H --> H1[ç‰ˆæœ¬æ§åˆ¶]
H --> H2[å®¡è®¡æ—¥å¿—]
H --> H3[ç›‘æ§æŒ‡æ ‡]
```

**å›¾è¡¨æ¥æº**
- [config.yaml](file://config.yaml#L1-L91)
- [config.test.yaml](file://config.test.yaml#L1-L80)

### ç¯å¢ƒå˜é‡è¦†ç›–

æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®ï¼š

| ç¯å¢ƒå˜é‡ | æè¿° | ç¤ºä¾‹å€¼ |
|---------|------|--------|
| `SERVER_ADMIN_PORT` | ç®¡ç† API ç«¯å£ | `8080` |
| `SERVER_MOCK_PORT` | Mock æœåŠ¡ç«¯å£ | `9090` |
| `DATABASE_MONGODB_URI` | MongoDB è¿æ¥å­—ç¬¦ä¸² | `mongodb://localhost:27017` |
| `LOGGING_LEVEL` | æ—¥å¿—çº§åˆ« | `debug` |
| `REDIS_URL` | Redis è¿æ¥ URL | `redis://localhost:6379` |
| `TZ` | æ—¶åŒºè®¾ç½® | `Asia/Shanghai` |

### é…ç½®æ–‡ä»¶æŒ‚è½½

åœ¨ Docker éƒ¨ç½²ä¸­ï¼Œå¯ä»¥é€šè¿‡å·æŒ‚è½½è‡ªå®šä¹‰é…ç½®ï¼š

```yaml
# docker-compose.yml
services:
  mockserver:
    volumes:
      - ./custom-config.yaml:/root/config.yaml
      - ./logs:/root/logs
```

### æŒä¹…åŒ–æ•°æ®å·

ç¡®ä¿å…³é”®æ•°æ®çš„æŒä¹…åŒ–ï¼š

```yaml
volumes:
  mongodb_data: # MongoDB æ•°æ®
  redis_data:   # Redis æ•°æ®
  logs:         # åº”ç”¨æ—¥å¿—
```

**ç« èŠ‚æ¥æº**
- [config.yaml](file://config.yaml#L1-L91)
- [config.test.yaml](file://config.test.yaml#L1-L80)

## å¥åº·æ£€æŸ¥ä¸ç›‘æ§

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

Mock Server æä¾›äº†å®Œå–„çš„å¥åº·æ£€æŸ¥æœºåˆ¶ï¼š

```mermaid
sequenceDiagram
participant LB as è´Ÿè½½å‡è¡¡å™¨
participant MS as Mock Server
participant DB as MongoDB
participant Redis as Redis
LB->>MS : GET /api/v1/system/health
MS->>DB : Ping æ•°æ®åº“
DB-->>MS : è¿æ¥çŠ¶æ€
MS->>Redis : Ping ç¼“å­˜
Redis-->>MS : è¿æ¥çŠ¶æ€
MS-->>LB : å¥åº·çŠ¶æ€å“åº”
Note over LB,Redis : å¥åº·æ£€æŸ¥é—´éš” : 30s
Note over LB,Redis : è¶…æ—¶æ—¶é—´ : 10s
Note over LB,Redis : é‡è¯•æ¬¡æ•° : 3
```

**å›¾è¡¨æ¥æº**
- [internal/service/health.go](file://internal/service/health.go#L68-L106)
- [internal/api/health_handler.go](file://internal/api/health_handler.go#L86-L136)

### å¥åº·æ£€æŸ¥ API

#### 1. åŸºç¡€å¥åº·æ£€æŸ¥

```bash
# ç®€å•å¥åº·æ£€æŸ¥
curl http://localhost:8080/api/v1/system/health

# å“åº”ç¤ºä¾‹
{
  "status": "healthy",
  "version": "v1.0.0",
  "app_name": "Mock Server",
  "uptime": "1h 30m 45s",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

#### 2. è¯¦ç»†å¥åº·æ£€æŸ¥

```bash
# åŒ…å«ç»„ä»¶çŠ¶æ€çš„è¯¦ç»†æ£€æŸ¥
curl "http://localhost:8080/api/v1/system/health?detailed=true"

# å“åº”ç¤ºä¾‹
{
  "status": "degraded",
  "version": "v1.0.0",
  "app_name": "Mock Server",
  "uptime": "1h 30m 45s",
  "timestamp": "2024-01-15T10:30:00Z",
  "components": {
    "database": {
      "status": "healthy",
      "message": "database connection established"
    },
    "cache": {
      "status": "unhealthy",
      "message": "cache connection failed",
      "details": {
        "error": "dial tcp: connection refused"
      }
    }
  }
}
```

### ç›‘æ§é›†æˆæ–¹æ¡ˆ

#### 1. Prometheus ç›‘æ§æŒ‡æ ‡

```yaml
# Prometheus é…ç½®
scrape_configs:
  - job_name: 'mockserver'
    static_configs:
      - targets: ['mockserver:8080']
    metrics_path: '/api/v1/metrics'
    scrape_interval: 15s
```

#### 2. Grafana ä»ªè¡¨æ¿

ç›‘æ§å…³é”®æŒ‡æ ‡ï¼š
- æœåŠ¡å¯ç”¨æ€§
- å“åº”æ—¶é—´
- é”™è¯¯ç‡
- æ•°æ®åº“è¿æ¥çŠ¶æ€
- ç¼“å­˜å‘½ä¸­ç‡

#### 3. è‡ªå®šä¹‰å¥åº·æ£€æŸ¥è„šæœ¬

```bash
#!/bin/bash
# è‡ªå®šä¹‰å¥åº·æ£€æŸ¥è„šæœ¬

check_service() {
    local url=$1
    local timeout=5
    
    if curl -f -s --max-time $timeout "$url" > /dev/null; then
        echo "âœ“ æœåŠ¡æ­£å¸¸: $url"
        return 0
    else
        echo "âœ— æœåŠ¡å¼‚å¸¸: $url"
        return 1
    fi
}

# æ£€æŸ¥ Mock Server
check_service "http://localhost:8080/api/v1/system/health"

# æ£€æŸ¥æ•°æ®åº“
check_service "http://localhost:8080/api/v1/system/health?detailed=true"
```

**ç« èŠ‚æ¥æº**
- [internal/service/health.go](file://internal/service/health.go#L68-L156)
- [internal/api/health_handler.go](file://internal/api/health_handler.go#L86-L151)

## æ—¥å¿—æ”¶é›†

### æ—¥å¿—é…ç½®

Mock Server ä½¿ç”¨ zap æ—¥å¿—åº“ï¼Œæ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼å’Œè½®è½¬ç­–ç•¥ï¼š

```mermaid
graph TD
A[åº”ç”¨æ—¥å¿—] --> B[æ—¥å¿—çº§åˆ«è¿‡æ»¤]
B --> C{è¾“å‡ºç›®æ ‡}
C --> |stdout| D[æ ‡å‡†è¾“å‡º]
C --> |file| E[æ–‡ä»¶è¾“å‡º]
E --> F[æ—¥å¿—è½®è½¬]
F --> G[æŒ‰å¤§å°è½®è½¬<br/>æœ€å¤§ 100MB]
F --> H[æŒ‰æ—¶é—´è½®è½¬<br/>ä¿ç•™ 30 å¤©]
F --> I[æœ€å¤šä¿ç•™ 10 ä¸ªæ–‡ä»¶]
D --> J[å®¹å™¨æ—¥å¿—æ”¶é›†]
E --> K[æœ¬åœ°æ—¥å¿—æ–‡ä»¶]
J --> L[Docker æ—¥å¿—é©±åŠ¨]
K --> M[æ—¥å¿—èšåˆç³»ç»Ÿ]
```

**å›¾è¡¨æ¥æº**
- [pkg/logger/logger.go](file://pkg/logger/logger.go#L1-L116)

### æ—¥å¿—é…ç½®é€‰é¡¹

#### 1. æ—¥å¿—çº§åˆ«

| çº§åˆ« | æè¿° | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `debug` | è°ƒè¯•ä¿¡æ¯ | å¼€å‘ç¯å¢ƒï¼Œé—®é¢˜æ’æŸ¥ |
| `info` | å¸¸è§„ä¿¡æ¯ | ç”Ÿäº§ç¯å¢ƒé»˜è®¤ |
| `warn` | è­¦å‘Šä¿¡æ¯ | æ½œåœ¨é—®é¢˜æé†’ |
| `error` | é”™è¯¯ä¿¡æ¯ | å¼‚å¸¸æƒ…å†µè®°å½• |

#### 2. è¾“å‡ºæ ¼å¼

| æ ¼å¼ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `json` | ç»“æ„åŒ–ï¼Œä¾¿äºè§£æ | ç”Ÿäº§ç¯å¢ƒï¼Œæ—¥å¿—èšåˆ |
| `text` | å¯è¯»æ€§å¼º | å¼€å‘è°ƒè¯• |

#### 3. æ–‡ä»¶è½®è½¬é…ç½®

```yaml
logging:
  level: "info"
  format: "json"
  output: "file"
  file:
    path: "./logs/mockserver.log"
    max_size: 100      # MB
    max_backups: 10
    max_age: 30        # days
```

### Docker æ—¥å¿—æ”¶é›†

#### 1. Docker æ—¥å¿—é©±åŠ¨

```bash
# ä½¿ç”¨ json-file é©±åŠ¨ï¼ˆé»˜è®¤ï¼‰
docker run -d --log-driver=json-file \
  --log-opt max-size=100m \
  --log-opt max-file=10 \
  mockserver:latest

# ä½¿ç”¨ syslog é©±åŠ¨
docker run -d --log-driver=syslog \
  --log-opt syslog-address=udp://localhost:514 \
  mockserver:latest
```

#### 2. Docker Compose æ—¥å¿—é…ç½®

```yaml
services:
  mockserver:
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
```

### æ—¥å¿—èšåˆç³»ç»Ÿ

#### 1. ELK Stack é›†æˆ

```yaml
# Elasticsearch é…ç½®
elasticsearch:
  image: docker.elastic.co/elasticsearch/elasticsearch:8.0.0
  environment:
    - discovery.type=single-node
    - xpack.security.enabled=false

# Logstash é…ç½®
logstash:
  image: docker.elastic.co/logstash/logstash:8.0.0
  volumes:
    - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf
  command: logstash -f /usr/share/logstash/pipeline/logstash.conf

# Kibana é…ç½®
kibana:
  image: docker.elastic.co/kibana/kibana:8.0.0
  ports:
    - "5601:5601"
```

#### 2. Fluentd é…ç½®

```yaml
# fluentd é…ç½®
<source>
  @type forward
</source>

<match mockserver.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  index_name mockserver
</match>
```

### æ—¥å¿—åˆ†æè„šæœ¬

```bash
#!/bin/bash
# æ—¥å¿—åˆ†æè„šæœ¬

LOG_FILE="/var/log/mockserver/mockserver.log"

# ç»Ÿè®¡é”™è¯¯æ•°é‡
error_count=$(grep -c "level=error" $LOG_FILE)

# ç»Ÿè®¡è­¦å‘Šæ•°é‡
warn_count=$(grep -c "level=warn" $LOG_FILE)

# ç»Ÿè®¡æœ€è¿‘1å°æ—¶çš„è¯·æ±‚é‡
hourly_requests=$(grep "$(date -d '1 hour ago' '+%Y-%m-%d %H')" $LOG_FILE | wc -l)

echo "é”™è¯¯æ•°é‡: $error_count"
echo "è­¦å‘Šæ•°é‡: $warn_count"
echo "æ¯å°æ—¶è¯·æ±‚æ•°: $hourly_requests"
```

**ç« èŠ‚æ¥æº**
- [pkg/logger/logger.go](file://pkg/logger/logger.go#L1-L116)
- [config.yaml](file://config.yaml#L49-L58)

## æ€§èƒ½ç›‘æ§

### ç›‘æ§æŒ‡æ ‡ä½“ç³»

Mock Server æä¾›äº†å…¨é¢çš„æ€§èƒ½ç›‘æ§æŒ‡æ ‡ï¼š

```mermaid
graph TB
subgraph "ç³»ç»ŸæŒ‡æ ‡"
A1[CPU ä½¿ç”¨ç‡]
A2[å†…å­˜ä½¿ç”¨é‡]
A3[ç£ç›˜ I/O]
A4[ç½‘ç»œæµé‡]
end
subgraph "åº”ç”¨æŒ‡æ ‡"
B1[è¯·æ±‚å“åº”æ—¶é—´]
B2[è¯·æ±‚æˆåŠŸç‡]
B3[å¹¶å‘è¿æ¥æ•°]
B4[é”™è¯¯ç‡]
end
subgraph "ä¸šåŠ¡æŒ‡æ ‡"
C1[Mock è§„åˆ™å‘½ä¸­ç‡]
C2[ç¼“å­˜å‘½ä¸­ç‡]
C3[æ•°æ®åº“æŸ¥è¯¢æ—¶é—´]
C4[API è°ƒç”¨é¢‘ç‡]
end
subgraph "åŸºç¡€è®¾æ–½æŒ‡æ ‡"
D1[æ•°æ®åº“è¿æ¥çŠ¶æ€]
D2[ç¼“å­˜è¿æ¥çŠ¶æ€]
D3[æœåŠ¡å¯ç”¨æ€§]
D4[å¥åº·æ£€æŸ¥çŠ¶æ€]
end
A1 --> E[Prometheus]
A2 --> E
A3 --> E
A4 --> E
B1 --> E
B2 --> E
B3 --> E
B4 --> E
C1 --> E
C2 --> E
C3 --> E
C4 --> E
D1 --> E
D2 --> E
D3 --> E
D4 --> E
```

### å…³é”®æ€§èƒ½æŒ‡æ ‡

#### 1. ç³»ç»Ÿèµ„æºç›‘æ§

| æŒ‡æ ‡ | ç›‘æ§é˜ˆå€¼ | å‘Šè­¦çº§åˆ« |
|------|----------|----------|
| CPU ä½¿ç”¨ç‡ | > 80% | è­¦å‘Š |
| å†…å­˜ä½¿ç”¨ç‡ | > 85% | è­¦å‘Š |
| ç£ç›˜ä½¿ç”¨ç‡ | > 90% | ä¸¥é‡ |
| ç½‘ç»œå¸¦å®½ | > 95% | è­¦å‘Š |

#### 2. åº”ç”¨æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | ç›‘æ§æ–¹æ³• |
|------|--------|----------|
| å¹³å‡å“åº”æ—¶é—´ | < 100ms | åº”ç”¨å†…éƒ¨ç»Ÿè®¡ |
| é”™è¯¯ç‡ | < 0.1% | é”™è¯¯è®¡æ•°å™¨ |
| QPS | æ ¹æ®ä¸šåŠ¡éœ€æ±‚ | è¯·æ±‚è®¡æ•°å™¨ |
| å¹¶å‘è¿æ¥æ•° | < 10000 | è¿æ¥æ± ç›‘æ§ |

#### 3. æ•°æ®åº“æ€§èƒ½ç›‘æ§

```yaml
# æ•°æ®åº“ç›‘æ§é…ç½®
database:
  mongodb:
    pool:
      min: 10
      max: 100
    timeout: 10s
performance:
  timeout:
    database_query: 10s
    database_write: 15s
```

### ç›‘æ§å·¥å…·é›†æˆ

#### 1. Prometheus + Grafana

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'mockserver'
    static_configs:
      - targets: ['mockserver:8080']
    metrics_path: '/api/v1/metrics'
    scrape_interval: 15s
```

#### 2. è‡ªå®šä¹‰ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# æ€§èƒ½ç›‘æ§è„šæœ¬

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service_health() {
    local response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/v1/system/health)
    if [ "$response" -eq 200 ]; then
        echo "âœ“ æœåŠ¡å¥åº·"
    else
        echo "âœ— æœåŠ¡å¼‚å¸¸: HTTP $response"
    fi
}

# æ£€æŸ¥å“åº”æ—¶é—´
check_response_time() {
    local start_time=$(date +%s%N)
    curl -s -o /dev/null http://localhost:8080/api/v1/system/health
    local end_time=$(date +%s%N)
    local duration=$((($end_time - $start_time) / 1000000))
    
    echo "å“åº”æ—¶é—´: ${duration}ms"
}

# æ£€æŸ¥èµ„æºä½¿ç”¨
check_resources() {
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
    local mem_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
    
    echo "CPU ä½¿ç”¨ç‡: ${cpu_usage}%"
    echo "å†…å­˜ä½¿ç”¨ç‡: ${mem_usage}%"
}
```

**ç« èŠ‚æ¥æº**
- [internal/api/health_handler.go](file://internal/api/health_handler.go#L56-L151)

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜è¯Šæ–­

#### 1. æœåŠ¡å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**ï¼šå®¹å™¨å¯åŠ¨åç«‹å³é€€å‡ºæˆ–æ— æ³•å¯åŠ¨

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs mockserver-app

# 2. æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep :8080
netstat -tulpn | grep :9090

# 3. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
docker exec mockserver-app cat /root/config.yaml | yaml-lint

# 4. æ£€æŸ¥èµ„æºé™åˆ¶
docker stats mockserver-app
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ç«¯å£å†²çªå¹¶ä¿®æ”¹é…ç½®
- éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼
- å¢åŠ èµ„æºé™åˆ¶

#### 2. æ•°æ®åº“è¿æ¥é—®é¢˜

**ç—‡çŠ¶**ï¼šæ—¥å¿—æ˜¾ç¤ºæ•°æ®åº“è¿æ¥é”™è¯¯

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥ MongoDB æœåŠ¡çŠ¶æ€
docker-compose ps mongodb

# 2. æ£€æŸ¥ç½‘ç»œè¿æ¥
docker network ls
docker network inspect mockserver_mockserver-network

# 3. æµ‹è¯• MongoDB è¿æ¥
docker exec -it mockserver-mongodb mongosh

# 4. æŸ¥çœ‹ MongoDB æ—¥å¿—
docker-compose logs mongodb
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿ MongoDB å®¹å™¨æ­£å¸¸è¿è¡Œ
- æ£€æŸ¥ç½‘ç»œé…ç½®
- éªŒè¯è¿æ¥å­—ç¬¦ä¸²

#### 3. Mock è§„åˆ™ä¸ç”Ÿæ•ˆ

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥è§„åˆ™æ˜¯å¦å¯ç”¨ (`enabled: true`)
2. ç¡®è®¤ `project_id` å’Œ `environment_id` æ­£ç¡®
3. æ£€æŸ¥è§„åˆ™ä¼˜å…ˆçº§å’ŒåŒ¹é…æ¡ä»¶
4. æŸ¥çœ‹è¯·æ±‚æ—¥å¿—

#### 4. æ€§èƒ½é—®é¢˜

**ä¼˜åŒ–å»ºè®®**ï¼š
- å¯ç”¨ Redis ç¼“å­˜
- å¢åŠ  MongoDB è¿æ¥æ± å¤§å°
- è°ƒæ•´æ—¥å¿—çº§åˆ«ä¸º `warn` æˆ– `error`
- ä½¿ç”¨ SSD å­˜å‚¨
- å¢åŠ æœåŠ¡å™¨èµ„æº

### æ•…éšœæ’æŸ¥æµç¨‹

```mermaid
flowchart TD
A[å‘ç°é—®é¢˜] --> B{é—®é¢˜ç±»å‹}
B --> |å¯åŠ¨é—®é¢˜| C[æ£€æŸ¥æ—¥å¿—]
B --> |è¿æ¥é—®é¢˜| D[æ£€æŸ¥ç½‘ç»œ]
B --> |åŠŸèƒ½é—®é¢˜| E[æ£€æŸ¥é…ç½®]
B --> |æ€§èƒ½é—®é¢˜| F[æ£€æŸ¥èµ„æº]
C --> G[æŸ¥çœ‹å®¹å™¨æ—¥å¿—]
G --> H[åˆ†æé”™è¯¯ä¿¡æ¯]
H --> I[ä¿®å¤é…ç½®/èµ„æº]
D --> J[æ£€æŸ¥æœåŠ¡çŠ¶æ€]
J --> K[æ£€æŸ¥ç½‘ç»œè¿é€šæ€§]
K --> L[ä¿®å¤ç½‘ç»œé…ç½®]
E --> M[éªŒè¯é…ç½®æ–‡ä»¶]
M --> N[æ£€æŸ¥è§„åˆ™è®¾ç½®]
N --> O[ä¿®å¤è§„åˆ™é…ç½®]
F --> P[ç›‘æ§èµ„æºä½¿ç”¨]
P --> Q[ä¼˜åŒ–é…ç½®å‚æ•°]
Q --> R[å¢åŠ ç¡¬ä»¶èµ„æº]
```

### ç›‘æ§å‘Šè­¦é…ç½®

#### 1. å…³é”®æŒ‡æ ‡å‘Šè­¦

```yaml
# AlertManager å‘Šè­¦è§„åˆ™
groups:
  - name: mockserver.rules
    rules:
      - alert: MockServerDown
        expr: up{job="mockserver"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Mock Server æœåŠ¡ä¸å¯ç”¨"
          
      - alert: HighErrorRate
        expr: rate(mockserver_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Mock Server é”™è¯¯ç‡è¿‡é«˜"
          
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, mockserver_request_duration_seconds) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Mock Server å“åº”æ—¶é—´è¿‡é•¿"
```

#### 2. è‡ªåŠ¨åŒ–æ•…éšœæ¢å¤

```bash
#!/bin/bash
# è‡ªåŠ¨æ•…éšœæ¢å¤è„šæœ¬

RESTART_THRESHOLD=3
RESTART_COUNT=0

while true; do
    # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
    HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/v1/system/health)
    
    if [ "$HEALTH_STATUS" -ne 200 ]; then
        RESTART_COUNT=$((RESTART_COUNT + 1))
        
        if [ $RESTART_COUNT -ge $RESTART_THRESHOLD ]; then
            echo "æœåŠ¡è¿ç»­ $RESTART_THRESHOLD æ¬¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡å¯æœåŠ¡"
            docker-compose restart mockserver
            RESTART_COUNT=0
        fi
    else
        RESTART_COUNT=0
    fi
    
    sleep 30
done
```

**ç« èŠ‚æ¥æº**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L708-L824)

## ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

### å®‰å…¨é…ç½®

#### 1. å¯†é’¥ç®¡ç†

```yaml
# ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®
security:
  jwt:
    secret: "your-strong-secret-key-here"  # ä½¿ç”¨å¼ºéšæœºå¯†é’¥
    expiration: 7200                      # 2å°æ—¶è¿‡æœŸ
  api_key:
    enabled: true                         # å¯ç”¨ API Key è®¤è¯
  ip_whitelist:
    enabled: true
    ips:
      - "192.168.1.0/24"
      - "10.0.0.0/8"
```

#### 2. ç½‘ç»œå®‰å…¨

```yaml
# ç½‘ç»œå®‰å…¨é…ç½®
server:
  admin:
    host: "127.0.0.1"  # ä»…æœ¬åœ°è®¿é—®
  mock:
    host: "0.0.0.0"    # æ ¹æ®éœ€è¦é™åˆ¶
```

#### 3. HTTPS é…ç½®

```nginx
# Nginx åå‘ä»£ç†é…ç½®
server {
    listen 443 ssl;
    server_name mockserver.example.com;
    
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### æ€§èƒ½ä¼˜åŒ–

#### 1. èµ„æºé…ç½®

| ç»„ä»¶ | æœ€å°é…ç½® | æ¨èé…ç½® | ç”Ÿäº§é…ç½® |
|------|----------|----------|----------|
| CPU | 2æ ¸ | 4æ ¸ | 8æ ¸+ |
| å†…å­˜ | 2GB | 4GB | 8GB+ |
| ç£ç›˜ | 20GB | 50GB SSD | 100GB+ SSD |
| ç½‘ç»œ | 100Mbps | 1Gbps | 10Gbps |

#### 2. ç¼“å­˜ä¼˜åŒ–

```yaml
# ç¼“å­˜é…ç½®ä¼˜åŒ–
performance:
  cache:
    rule_ttl: 300      # è§„åˆ™ç¼“å­˜ 5åˆ†é’Ÿ
    config_ttl: 1800   # é…ç½®ç¼“å­˜ 30åˆ†é’Ÿ
  rate_limit:
    enabled: true
    ip_limit: 1000     # æ¯åˆ†é’Ÿ 1000æ¬¡
    global_limit: 10000 # æ¯ç§’ 10000æ¬¡
```

#### 3. æ•°æ®åº“ä¼˜åŒ–

```yaml
# æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
database:
  mongodb:
    uri: "mongodb://mongodb:27017/?maxPoolSize=100&minPoolSize=10"
    timeout: 10s
    pool:
      min: 10
      max: 100
```

### å¤‡ä»½ç­–ç•¥

#### 1. æ•°æ®å¤‡ä»½

```bash
#!/bin/bash
# è‡ªåŠ¨å¤‡ä»½è„šæœ¬

BACKUP_DIR="/backup/mockserver"
DATE=$(date +%Y%m%d_%H%M%S)

# MongoDB å¤‡ä»½
docker exec mockserver-mongodb mongodump \
  --db mockserver \
  --out $BACKUP_DIR/mongodb_$DATE

# Redis å¤‡ä»½
docker exec mockserver-redis redis-cli \
  BGSAVE

# å¤åˆ¶ Redis å¤‡ä»½æ–‡ä»¶
docker cp mockserver-redis:/data/dump.rdb \
  $BACKUP_DIR/redis_$DATE.rdb

# å‹ç¼©å¤‡ä»½
tar -czf $BACKUP_DIR/backup_$DATE.tar.gz \
  -C $BACKUP_DIR .

# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™30å¤©ï¼‰
find $BACKUP_DIR -name "backup_*.tar.gz" -mtime +30 -delete
```

#### 2. é…ç½®å¤‡ä»½

```bash
#!/bin/bash
# é…ç½®å¤‡ä»½è„šæœ¬

CONFIG_BACKUP_DIR="/backup/config"
DATE=$(date +%Y%m%d_%H%M%S)

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp config.yaml $CONFIG_BACKUP_DIR/config_$DATE.yaml
cp docker-compose.yml $CONFIG_BACKUP_DIR/docker-compose_$DATE.yml

# å¤‡ä»½è¯ä¹¦æ–‡ä»¶
cp -r certs $CONFIG_BACKUP_DIR/certs_$DATE/

# ä¸Šä¼ åˆ°è¿œç¨‹å­˜å‚¨
aws s3 sync $CONFIG_BACKUP_DIR s3://your-backup-bucket/config/
```

### ç›‘æ§å‘Šè­¦

#### 1. å…³é”®æŒ‡æ ‡ç›‘æ§

```yaml
# ç›‘æ§æŒ‡æ ‡é…ç½®
prometheus:
  scrape_configs:
    - job_name: 'mockserver'
      static_configs:
        - targets: ['mockserver:8080']
      metrics_path: '/api/v1/metrics'
      scrape_interval: 15s
      
      # è‡ªå®šä¹‰å‘Šè­¦è§„åˆ™
      alerting:
        alertmanagers:
          - static_configs:
              - targets:
                - alertmanager:9093
```

#### 2. å‘Šè­¦é€šçŸ¥

```yaml
# AlertManager é…ç½®
route:
  group_by: ['alertname', 'service']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
  receiver: 'slack-notifications'

receivers:
  - name: 'slack-notifications'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#alerts'
        title: '{{ .GroupLabels.alertname }}'
        text: '{{ .CommonAnnotations.description }}'
```

**ç« èŠ‚æ¥æº**
- [config.yaml](file://config.yaml#L34-L47)
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L770-L824)

## å‡çº§ä¸ç»´æŠ¤

### å‡çº§ç­–ç•¥

#### 1. è“ç»¿éƒ¨ç½²

```mermaid
sequenceDiagram
participant LB as è´Ÿè½½å‡è¡¡å™¨
participant Blue as è“è‰²ç¯å¢ƒ
participant Green as ç»¿è‰²ç¯å¢ƒ
participant DB as æ•°æ®åº“
Note over LB,DB : è“ç»¿éƒ¨ç½²æµç¨‹
LB->>Blue : æµé‡è·¯ç”±åˆ°è“è‰²ç¯å¢ƒ
Blue-->>LB : æœåŠ¡æ­£å¸¸
Note over Green : éƒ¨ç½²æ–°ç‰ˆæœ¬
Green->>DB : è¿ç§»æ•°æ®åº“
Green->>Green : å¯åŠ¨æ–°æœåŠ¡
Note over LB : åˆ‡æ¢æµé‡
LB->>Green : æµé‡è·¯ç”±åˆ°ç»¿è‰²ç¯å¢ƒ
Green-->>LB : æœåŠ¡æ­£å¸¸
Note over LB : å¥åº·æ£€æŸ¥ç¡®è®¤
LB->>Green : å¥åº·æ£€æŸ¥
Green-->>LB : æ£€æŸ¥é€šè¿‡
Note over LB : æ¸…ç†æ—§ç¯å¢ƒ
LB->>Blue : åœæ­¢è“è‰²ç¯å¢ƒ
```

#### 2. æ»šåŠ¨æ›´æ–°

```yaml
# Kubernetes æ»šåŠ¨æ›´æ–°é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mockserver
spec:
  replicas: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  template:
    spec:
      containers:
      - name: mockserver
        image: mockserver:v1.1.0
        imagePullPolicy: Always
```

### ç»´æŠ¤ä»»åŠ¡

#### 1. å®šæœŸç»´æŠ¤è®¡åˆ’

| ä»»åŠ¡ | é¢‘ç‡ | è´Ÿè´£äºº | æ³¨æ„äº‹é¡¹ |
|------|------|--------|----------|
| æ—¥å¿—æ¸…ç† | æ¯æ—¥ | è¿ç»´å›¢é˜Ÿ | ä¿ç•™7å¤©æ—¥å¿— |
| å¤‡ä»½éªŒè¯ | æ¯å‘¨ | è¿ç»´å›¢é˜Ÿ | æµ‹è¯•æ¢å¤æµç¨‹ |
| å®‰å…¨è¡¥ä¸ | æŒ‰éœ€ | å®‰å…¨å›¢é˜Ÿ | åŠæ—¶æ›´æ–° |
| æ€§èƒ½ä¼˜åŒ– | æ¯æœˆ | è¿ç»´å›¢é˜Ÿ | ç›‘æ§æŒ‡æ ‡åˆ†æ |
| å®¹é‡è§„åˆ’ | æ¯å­£åº¦ | è¿ç»´å›¢é˜Ÿ | é¢„æµ‹å¢é•¿è¶‹åŠ¿ |

#### 2. ç»´æŠ¤è„šæœ¬

```bash
#!/bin/bash
# ç³»ç»Ÿç»´æŠ¤è„šæœ¬

LOG_FILE="/var/log/maintenance.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

log_message() {
    echo "[$DATE] $1" | tee -a $LOG_FILE
}

# 1. å¤‡ä»½å½“å‰é…ç½®
log_message "å¼€å§‹å¤‡ä»½é…ç½®æ–‡ä»¶"
cp config.yaml config.yaml.backup.$(date +%Y%m%d)
cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d)

# 2. æ¸…ç†æ—¥å¿—æ–‡ä»¶
log_message "æ¸…ç†æ—¥å¿—æ–‡ä»¶"
find /var/log/mockserver -name "*.log" -mtime +7 -delete

# 3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
log_message "æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
find /tmp -name "mockserver-*" -mtime +1 -delete

# 4. æ£€æŸ¥ç£ç›˜ç©ºé—´
log_message "æ£€æŸ¥ç£ç›˜ç©ºé—´"
DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    log_message "è­¦å‘Šï¼šç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜ ($DISK_USAGE%)"
fi

# 5. é‡å¯æœåŠ¡ï¼ˆå¯é€‰ï¼‰
log_message "é‡å¯æœåŠ¡"
docker-compose restart mockserver

log_message "ç»´æŠ¤ä»»åŠ¡å®Œæˆ"
```

### ç‰ˆæœ¬ç®¡ç†

#### 1. ç‰ˆæœ¬æ ‡ç­¾è§„èŒƒ

```bash
# ç‰ˆæœ¬å·æ ¼å¼
# v{major}.{minor}.{patch}[-{prerelease}][-{build}]
# ç¤ºä¾‹ï¼šv1.0.0, v1.1.0-beta.1, v1.1.0+20240115

# åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
git tag -a v1.1.0 -m "Release version 1.1.0"
git push origin v1.1.0
```

#### 2. å‘å¸ƒæµç¨‹

```bash
#!/bin/bash
# è‡ªåŠ¨å‘å¸ƒè„šæœ¬

VERSION=$1
if [ -z "$VERSION" ]; then
    echo "ç”¨æ³•: $0 <ç‰ˆæœ¬å·>"
    exit 1
fi

# 1. éªŒè¯ç‰ˆæœ¬æ ¼å¼
if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
    echo "é”™è¯¯ï¼šç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®"
    exit 1
fi

# 2. è¿è¡Œæµ‹è¯•
make test-all

# 3. æ„å»ºé•œåƒ
make docker-build
docker tag mockserver:latest mockserver:$VERSION

# 4. æ¨é€é•œåƒ
docker push mockserver:$VERSION
docker push mockserver:latest

# 5. åˆ›å»º Git æ ‡ç­¾
git tag -a $VERSION -m "Release $VERSION"
git push origin $VERSION

# 6. æ›´æ–°æ–‡æ¡£
make docs
git add docs/
git commit -m "Update docs for $VERSION"
git push origin main
```

**ç« èŠ‚æ¥æº**
- [Makefile](file://Makefile#L608-L620)
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L770-L824)