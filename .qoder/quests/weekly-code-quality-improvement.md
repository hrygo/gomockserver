# Sprint 01: MVP 改进计划 - v0.1.1

## 概述

本文档规划为期 1 周的集中改进冲刺（Sprint），目标是在 v0.1.0 MVP 版本的基础上，系统性地提升项目的代码质量、测试覆盖率、工程化水平，并增加部分高价值功能，使项目更加稳定、可靠、易用。

### 版本信息

- **当前版本**: v0.1.0
- **目标版本**: v0.1.1
- **Sprint 周期**: 5 个工作日
- **发布类型**: 补丁版本（Patch Release）

### 核心目标

1. **质量提升**: 将整体测试覆盖率从 50.8% 提升至 70%+
2. **工程优化**: 完善 CI/CD 流程，增强自动化能力
3. **文档完善**: 补充 API 文档和最佳实践指南
4. **功能增强**: 添加高价值的辅助功能，提升开发者体验

## 当前状态分析

### 测试覆盖率现状

| 模块 | 当前覆盖率 | 评级 | 优先级 |
|------|-----------|------|--------|
| Adapter | 96.3% | 优秀 | 低 |
| API | 89.5% | 优秀 | 低 |
| Config | 94.4% | 优秀 | 低 |
| Engine | 89.8% | 优秀 | 低 |
| Executor | 86.0% | 优秀 | 低 |
| **Repository** | **44.4%** | 待提升 | **高** |
| **Service** | **16.7%** | 待提升 | **高** |
| Models | 0% | 数据模型 | 中 |
| **总体** | **50.8%** | 及格 | - |

### 技术债务清单

| 类型 | 问题描述 | 影响范围 | 优先级 |
|------|---------|---------|--------|
| 测试覆盖 | Repository 层覆盖率过低（44.4%） | 数据可靠性 | P0 |
| 测试覆盖 | Service 层覆盖率过低（16.7%） | 业务逻辑可靠性 | P0 |
| 文档缺失 | 缺少 API 详细文档（Swagger/OpenAPI） | 开发者体验 | P1 |
| 代码规范 | 部分代码缺少必要注释 | 可维护性 | P2 |
| 错误处理 | 错误信息不够友好和规范 | 用户体验 | P1 |
| 日志规范 | 日志级别和格式不统一 | 可观测性 | P2 |
| 性能监控 | 缺少请求时长和性能指标采集 | 可观测性 | P1 |
| 配置验证 | 配置文件缺少完整性校验 | 稳定性 | P1 |

### 功能需求分析

基于 MVP 使用反馈和实际需求，识别出以下高价值功能：

1. **规则导入导出**: 支持 JSON/YAML 格式的规则批量导入导出
2. **规则复制功能**: 快速基于现有规则创建新规则
3. **批量操作**: 支持批量启用/禁用规则
4. **规则搜索**: 支持按名称、路径、标签搜索规则
5. **健康检查增强**: 包含数据库连接状态、版本信息等
6. **请求日志**: 记录 Mock 请求的基本信息（可选功能）

## Sprint 工作规划

### Day 1: 测试覆盖率提升 - Repository 层

**目标**: 将 Repository 层覆盖率从 44.4% 提升至 80%+

#### 任务清单

##### 1.1 ProjectRepository 测试完善

**范围**: internal/repository/project_repository.go

**测试场景设计**:

- 正常场景测试
  - 创建项目（正常数据）
  - 通过 ID 获取项目
  - 更新项目信息
  - 删除项目
  - 列出所有项目（分页）
  
- 边界场景测试
  - 创建重复项目（同名项目）
  - 获取不存在的项目（ID 不存在）
  - 更新不存在的项目
  - 删除不存在的项目
  - 空查询条件列表
  - 分页边界（page=0, limit=0, 超大 limit）
  
- 异常场景测试
  - 数据库连接失败
  - 无效的 ObjectID 格式
  - 必填字段缺失
  - 字段长度超限

**预期输出**:
- 新增测试用例数: 15-20 个
- 覆盖率目标: 85%+

##### 1.2 RuleRepository 测试完善

**范围**: internal/repository/rule_repository.go

**测试场景设计**:

- 正常场景测试
  - 创建规则（完整数据）
  - 通过 ID 获取规则
  - 更新规则（全量更新）
  - 删除规则
  - 按项目和环境查询规则
  - 启用/禁用规则
  - 按优先级排序查询
  
- 边界场景测试
  - 创建最小化规则（仅必填字段）
  - 查询空结果集
  - 更新部分字段
  - 同一项目下多规则优先级排序
  - 启用已启用的规则
  - 禁用已禁用的规则
  
- 异常场景测试
  - 无效的 project_id
  - 无效的 environment_id
  - 规则优先级为负数
  - 匹配条件格式错误
  - 响应内容格式错误

**预期输出**:
- 新增测试用例数: 20-25 个
- 覆盖率目标: 80%+

##### 1.3 EnvironmentRepository 测试完善

**范围**: internal/repository/（如有 environment_repository.go）

**测试场景设计**:

- 正常场景测试
  - 创建环境
  - 获取环境
  - 更新环境
  - 删除环境
  - 按项目查询环境列表
  
- 边界和异常场景测试
  - 重复环境名称
  - 不存在的项目关联
  - 环境删除后的规则关联处理

**预期输出**:
- 新增测试用例数: 10-15 个
- 覆盖率目标: 80%+

#### 技术实施要点

**测试环境配置**:
- 使用 testcontainers 或 Docker Compose 启动测试专用 MongoDB
- 每个测试用例前后清理数据库状态
- 使用测试数据构建器（Builder Pattern）简化测试数据准备

**Mock vs 真实数据库**:
- 优先使用真实 MongoDB 进行集成测试
- 对于数据库连接失败等异常场景，使用 Mock

**断言策略**:
- 使用 testify/assert 进行断言
- 验证返回数据的完整性和准确性
- 验证错误类型和错误信息

---

### Day 2: 测试覆盖率提升 - Service 层

**目标**: 将 Service 层覆盖率从 16.7% 提升至 75%+

#### 任务清单

##### 2.1 AdminService 测试完善

**范围**: internal/service/admin_service.go

**测试场景设计**:

- 项目管理测试
  - 创建项目（各种输入组合）
  - 获取项目（存在/不存在）
  - 更新项目（全量/部分字段）
  - 删除项目（级联删除环境和规则）
  - 输入验证（名称格式、长度限制）
  
- 环境管理测试
  - 创建环境（各种配置）
  - 获取环境
  - 更新环境
  - 删除环境（级联删除规则）
  - 环境 base_url 格式验证
  
- 规则管理测试
  - 创建规则（各种匹配条件和响应配置）
  - 获取规则
  - 更新规则（匹配条件变更、响应内容变更）
  - 删除规则
  - 批量查询规则
  - 启用/禁用规则
  - 规则优先级排序

**依赖 Mock 策略**:
- Mock Repository 层接口
- 使用 testify/mock 或 gomock 生成 Mock 对象
- 验证 Service 层的业务逻辑和参数校验

**预期输出**:
- 新增测试用例数: 30-40 个
- 覆盖率目标: 75%+

##### 2.2 MockService 测试完善

**范围**: internal/service/mock_service.go

**测试场景设计**:

- Mock 请求处理测试
  - 匹配成功场景（各种协议和匹配条件）
  - 匹配失败场景（无匹配规则）
  - 多规则优先级测试
  - 路径参数提取测试
  - Query 参数匹配测试
  - Header 匹配测试
  - IP 白名单验证测试
  
- 响应生成测试
  - 静态响应生成（JSON/XML/HTML/Text）
  - 响应延迟配置（固定/随机）
  - 自定义响应头处理
  - 自定义状态码处理
  
- 错误处理测试
  - 项目不存在
  - 环境不存在
  - 规则查询失败
  - 响应生成失败

**预期输出**:
- 新增测试用例数: 25-30 个
- 覆盖率目标: 75%+

#### 技术实施要点

**测试组织结构**:
- 使用表驱动测试（Table-Driven Tests）
- 每个公共方法至少对应一个测试函数
- 分组测试场景（正常、边界、异常）

---

### Day 3: 工程化提升与文档完善

**目标**: 提升工程化水平，完善开发者文档

#### 任务清单

##### 3.1 CI/CD 流程优化

**当前状态**: 基础的 GitHub Actions 配置

**优化方向**:

1. **测试流水线增强**
   - 添加测试覆盖率检查（覆盖率低于阈值则失败）
   - 生成覆盖率徽章（Badge）
   - 上传覆盖率报告到 Codecov 或 Coveralls
   - 添加集成测试阶段

2. **代码质量门禁**
   - 集成 golangci-lint 检查
   - 添加代码复杂度检查
   - 添加安全扫描（gosec）
   - 依赖漏洞扫描（govulncheck）

3. **构建优化**
   - 添加多平台构建（Linux/macOS/Windows）
   - 构建产物自动上传到 Release
   - Docker 镜像自动推送到 Docker Hub

4. **自动化发布**
   - 基于 Git Tag 触发发布流程
   - 自动生成 Release Notes
   - 自动更新 CHANGELOG.md

**配置文件**: .github/workflows/ci.yml

**预期输出**:
- 完整的 CI/CD 配置文件
- 测试覆盖率徽章
- 自动化发布流程

##### 3.2 Makefile 命令完善

**当前状态**: 基础命令已存在

**新增命令规划**:

| 命令 | 功能说明 |
|------|---------|
| make test-coverage-check | 检查覆盖率是否达标 |
| make security-scan | 安全扫描 |
| make code-analysis | 代码质量分析 |
| make test-repository | 仅测试 Repository 层 |
| make test-service | 仅测试 Service 层 |
| make test-api | 仅测试 API 层 |
| make mock-generate | 生成 Mock 对象 |
| make swagger-generate | 生成 Swagger 文档 |
| make deps-upgrade | 检查并升级依赖 |

##### 3.3 API 文档生成

**工具选择**: Swagger/OpenAPI 3.0

**实施方案**:

1. **集成 swaggo/swag**
   - 安装 swag CLI 工具
   - 在 API Handler 中添加 Swagger 注释
   - 自动生成 OpenAPI 规范文件

2. **注释规范**
   - 每个 API 端点添加完整注释
   - 包含请求参数、响应格式、错误码说明
   - 提供请求示例

3. **Swagger UI 集成**
   - 在管理 API 服务中嵌入 Swagger UI
   - 路由: GET /api/v1/docs
   - 支持在线调试 API

**预期输出**:
- 完整的 Swagger 注释
- 自动生成的 OpenAPI 规范文件
- 可访问的 Swagger UI 页面

##### 3.4 开发者文档完善

**新增文档**:

1. **ARCHITECTURE.md 更新**
   - 补充详细的模块交互图
   - 添加数据流图
   - 补充设计决策说明

2. **TESTING_GUIDE.md**（新建）
   - 测试框架使用指南
   - 如何编写单元测试
   - 如何编写集成测试
   - Mock 对象使用示例
   - 测试数据准备最佳实践

3. **API_GUIDE.md**（新建）
   - 完整的 API 使用指南
   - 每个端点的详细说明
   - 请求和响应示例
   - 错误码参考
   - 最佳实践建议

4. **DEVELOPMENT.md**（新建）
   - 开发环境搭建
   - 本地调试指南
   - 代码提交规范
   - PR 流程说明
   - 常见问题解答

**预期输出**:
- 4 个新增/更新的技术文档
- 总计约 10,000 字

---

### Day 4: 功能增强 - 辅助功能实现

**目标**: 实现高价值的辅助功能，提升开发者体验

#### 任务清单

##### 4.1 规则导入导出功能

**功能描述**:
支持将规则以 JSON 或 YAML 格式导出，并支持批量导入规则。

**API 设计**:

1. **导出规则**
   - 端点: GET /api/v1/rules/export
   - 查询参数:
     - project_id (必填): 项目 ID
     - environment_id (可选): 环境 ID
     - format (可选): json | yaml，默认 json
   - 响应: 规则列表的 JSON/YAML 文件

2. **导入规则**
   - 端点: POST /api/v1/rules/import
   - 请求体: multipart/form-data 或 application/json
   - 支持参数:
     - file: 上传的 JSON/YAML 文件
     - mode: 导入模式（replace | merge），默认 merge
     - project_id: 目标项目 ID
     - environment_id: 目标环境 ID（可选）
   - 响应: 导入结果统计（成功数、失败数、跳过数）

**数据模型定义**:

导出格式包含以下字段：
- version: 导出格式版本号
- export_time: 导出时间戳
- project_id: 项目标识
- environment_id: 环境标识
- rules: 规则列表数组

**实现要点**:
- 支持 JSON 和 YAML 格式互转
- 导入时验证数据格式和完整性
- 支持覆盖导入和合并导入两种模式
- 提供详细的导入结果反馈

**测试覆盖**:
- 导出功能测试（各种查询条件）
- 导入功能测试（正常、格式错误、数据冲突）
- 格式转换测试

##### 4.2 规则复制功能

**功能描述**:
基于现有规则快速创建新规则，减少重复配置工作。

**API 设计**:

- 端点: POST /api/v1/rules/:id/clone
- 路径参数: id (源规则 ID)
- 请求体包含:
  - name: 新规则名称
  - project_id: 目标项目 ID（可选）
  - environment_id: 目标环境 ID（可选）
  - priority: 优先级
- 响应: 新创建的规则对象

**实现逻辑**:
1. 读取源规则
2. 复制所有匹配条件和响应配置
3. 应用新的名称、项目、环境、优先级
4. 创建新规则并返回

**测试覆盖**:
- 同项目内复制
- 跨项目复制
- 跨环境复制
- 源规则不存在

##### 4.3 批量操作功能

**功能描述**:
支持批量启用/禁用规则，提高操作效率。

**API 设计**:

1. **批量启用规则**
   - 端点: POST /api/v1/rules/batch/enable
   - 请求体: 包含 rule_ids 数组
   - 响应: 操作结果统计

2. **批量禁用规则**
   - 端点: POST /api/v1/rules/batch/disable
   - 请求体: 包含 rule_ids 数组
   - 响应: 操作结果统计

3. **批量删除规则**
   - 端点: DELETE /api/v1/rules/batch
   - 请求体: 包含 rule_ids 数组
   - 响应: 操作结果统计

**响应格式包含**:
- success_count: 成功数量
- failed_count: 失败数量
- results: 每条记录的操作结果详情

**实现要点**:
- 使用事务或批量操作提高性能
- 部分失败时返回详细的错误信息
- 限制批量操作的最大数量（如 100 条）

##### 4.4 规则搜索功能

**功能描述**:
支持按名称、路径、方法等条件搜索规则。

**API 设计**:

- 端点: GET /api/v1/rules/search
- 查询参数:
  - project_id (必填): 项目 ID
  - environment_id (可选): 环境 ID
  - keyword (可选): 关键词（搜索名称和路径）
  - method (可选): HTTP 方法
  - enabled (可选): 启用状态
  - page, limit: 分页参数

**搜索逻辑**:
- keyword: 在规则名称和匹配路径中进行模糊搜索
- method: 精确匹配 HTTP 方法
- 组合条件使用 AND 逻辑

**实现要点**:
- 使用 MongoDB 的文本索引或正则表达式搜索
- 支持分页
- 按优先级排序返回结果

##### 4.5 健康检查增强

**功能描述**:
增强健康检查端点，提供更详细的系统状态信息。

**API 设计**:

- 端点: GET /api/v1/system/health
- 响应内容包含:
  - status: 整体健康状态
  - version: 系统版本
  - uptime: 运行时长
  - timestamp: 当前时间戳
  - components: 各组件状态（数据库、API 服务器、Mock 服务器）
  - statistics: 数据统计（项目数、环境数、规则数）

**实现要点**:
- 检查 MongoDB 连接状态
- 计算服务运行时间
- 统计当前数据量
- 可配置是否返回详细信息

**预期输出**:
- 5 个新增 API 端点
- 完整的单元测试和集成测试
- API 文档更新

---

### Day 5: 错误处理与日志规范化

**目标**: 统一错误处理机制，规范化日志输出

#### 任务清单

##### 5.1 统一错误码体系

**设计目标**:
建立一套完整的错误码体系，提供清晰的错误信息。

**错误码分类**:

| 错误码范围 | 类别 | 说明 |
|-----------|------|------|
| 1000-1999 | 通用错误 | 参数错误、认证错误等 |
| 2000-2999 | 项目相关 | 项目不存在、项目创建失败等 |
| 3000-3999 | 环境相关 | 环境不存在、环境配置错误等 |
| 4000-4999 | 规则相关 | 规则不存在、规则匹配失败等 |
| 5000-5999 | 数据库相关 | 连接失败、查询失败等 |
| 9000-9999 | 系统错误 | 内部错误、未知错误等 |

**错误码定义位置**: internal/models/errors.go

**错误响应格式设计**:
- error.code: 错误码
- error.message: 错误信息（英文）
- error.details: 详细说明
- error.request_id: 请求唯一标识

**实施要点**:
- 定义完整的错误码常量
- 创建错误响应构建器
- 在所有 API Handler 中使用统一错误响应
- 支持国际化（中英文错误信息）

##### 5.2 日志规范化

**当前问题**:
- 日志级别使用不一致
- 缺少结构化字段
- 缺少请求追踪 ID

**改进方案**:

1. **日志级别使用规范**
   - DEBUG: 详细的调试信息（仅开发环境）
   - INFO: 关键业务流程节点
   - WARN: 警告信息（可恢复的异常）
   - ERROR: 错误信息（需要关注的错误）
   - FATAL: 致命错误（导致服务终止）

2. **结构化日志字段**
   - request_id: 请求唯一标识
   - user_id: 用户 ID（如有认证）
   - project_id: 项目 ID
   - rule_id: 规则 ID
   - action: 操作类型（create/update/delete/query）
   - duration: 操作耗时
   - error: 错误信息（如有）

3. **请求追踪**
   - 使用中间件为每个请求生成唯一的 request_id
   - 在整个调用链路中传递 request_id
   - 在响应头中返回 X-Request-ID

**实施要点**:
- 创建日志中间件（添加 request_id）
- 更新所有日志调用，使用结构化字段
- 配置日志输出格式（JSON 格式用于生产环境）
- 添加日志轮转配置

##### 5.3 输入验证增强

**验证框架**: 使用 go-playground/validator/v10

**实施方案**:
- 在所有 API 请求结构体中添加验证标签
- 创建统一的验证错误转换函数
- 添加自定义验证规则（如 mongodb ObjectID 格式、URL 格式等）
- 编写验证规则测试

**验证规则覆盖**:
- 必填字段验证
- 字段长度限制
- 格式验证（URL、Email、ID 等）
- 数值范围验证
- 枚举值验证

##### 5.4 性能监控中间件

**功能描述**:
添加请求性能监控中间件，记录请求处理时长。

**监控指标**:
- 请求处理总时长
- 数据库查询时长
- 外部调用时长（如有）

**实现方式**:
- 创建 Gin 中间件记录请求开始和结束时间
- 在日志中记录请求耗时
- 慢请求告警（超过阈值的请求）
- 在 Repository 层记录查询时长

**预期输出**:
- 统一的错误码体系（约 50 个错误码）
- 规范化的日志输出
- 完善的输入验证
- 性能监控中间件

---

## 质量保证

### 测试策略

#### 单元测试

**覆盖率目标**:
- Repository 层: 80%+
- Service 层: 75%+
- API 层: 85%+（当前 89.5%，保持）
- 总体覆盖率: 70%+

**测试工具**:
- 测试框架: testing（Go 标准库）
- 断言库: testify/assert
- Mock 工具: gomock 或 testify/mock
- 覆盖率工具: go test -cover

#### 集成测试

**测试范围**:
- 完整的 API 调用流程
- 数据库操作验证
- 新增功能的端到端测试

**测试环境**:
- 使用 Docker Compose 启动测试环境
- 独立的测试数据库
- 自动化测试脚本

#### 性能测试

**测试指标**:
- 规则匹配性能（目标: < 10ms）
- API 响应时间（目标: < 50ms）
- 并发处理能力（目标: 10,000+ QPS）

**测试工具**:
- wrk: HTTP 压力测试
- go test -bench: 基准测试

### 代码审查检查清单

**功能性**:
- 功能实现符合需求
- 边界条件处理正确
- 错误处理完善

**代码质量**:
- 代码格式符合规范（gofmt）
- 无 lint 警告
- 注释清晰完整
- 命名规范

**测试**:
- 单元测试完整
- 测试用例覆盖主要场景
- 测试通过

**文档**:
- API 文档更新
- CHANGELOG 更新
- 代码注释完整

### 发布标准

**必须满足的条件**:
1. 所有单元测试通过
2. 所有集成测试通过
3. 测试覆盖率达到 70%+
4. 代码静态检查通过（golangci-lint）
5. API 文档完整
6. CHANGELOG 更新
7. 性能测试达标

## 成果交付

### 代码交付物

1. **测试代码**
   - Repository 层测试: 约 1,000 行
   - Service 层测试: 约 1,500 行
   - 新增功能测试: 约 800 行

2. **功能代码**
   - 规则导入导出: 约 400 行
   - 规则复制功能: 约 150 行
   - 批量操作: 约 300 行
   - 规则搜索: 约 200 行
   - 健康检查增强: 约 150 行
   - 错误处理框架: 约 300 行
   - 日志中间件: 约 200 行

3. **配置文件**
   - CI/CD 配置更新
   - Makefile 命令新增
   - Swagger 配置

### 文档交付物

1. **技术文档**
   - TESTING_GUIDE.md（新增，约 3,000 字）
   - API_GUIDE.md（新增，约 5,000 字）
   - DEVELOPMENT.md（新增，约 2,000 字）
   - ARCHITECTURE.md（更新，新增 1,000 字）

2. **API 文档**
   - Swagger/OpenAPI 规范文件
   - Swagger UI 页面

3. **发布文档**
   - CHANGELOG.md 更新
   - RELEASE_NOTES_v0.1.1.md

### 测试报告

1. **覆盖率报告**
   - 总体覆盖率报告（HTML）
   - 各模块覆盖率详情

2. **性能测试报告**
   - API 性能基准测试结果
   - 并发性能测试结果

3. **集成测试报告**
   - 端到端测试结果
   - 功能验证清单

## 风险评估与缓解

### 潜在风险

| 风险项 | 影响 | 概率 | 缓解措施 |
|-------|------|------|---------|
| 测试覆盖率目标未达成 | 中 | 低 | 调整测试范围，优先核心场景 |
| 新功能开发延期 | 中 | 中 | 功能分优先级，可延后部分功能 |
| 性能回归 | 高 | 低 | 每日运行性能测试，及时发现 |
| 依赖库兼容性问题 | 低 | 低 | 依赖升级前充分测试 |
| 文档编写时间不足 | 低 | 中 | 并行编写文档，每日更新 |

### 回滚方案

如果在 Sprint 结束时发现严重问题：
1. 停止合并新功能分支
2. 修复关键问题
3. 延期发布，继续测试
4. 如无法及时修复，回滚到 v0.1.0

## 后续规划

### v0.2.0 规划方向

基于本次 Sprint 的成果，v0.2.0 可考虑以下方向：

1. **协议扩展**
   - WebSocket 协议支持
   - gRPC 协议支持

2. **匹配增强**
   - 正则表达式匹配
   - JSON Path 匹配

3. **响应增强**
   - 动态响应模板
   - 响应数据 Faker

4. **可观测性**
   - 请求日志持久化
   - 统计分析功能
   - Metrics 指标导出

### 持续改进方向

1. **代码质量**
   - 持续提升测试覆盖率至 85%+
   - 引入代码质量评分机制

2. **性能优化**
   - 规则缓存机制
   - 数据库查询优化

3. **开发者体验**
   - CLI 工具开发
   - VS Code 插件

4. **社区建设**
   - 贡献者指南完善
   - Issue 和 PR 模板
   - 社区讨论机制
