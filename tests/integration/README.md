# 集成测试文档

本目录包含 Mock Server 的集成测试套件。

## 📁 目录结构

```
tests/integration/
├── e2e_test.sh           # 端到端集成测试脚本
└── README.md            # 本文档
```

## 🎯 测试目标

端到端集成测试覆盖完整的业务流程，验证系统各组件的集成是否正常工作。

## 📝 测试场景

### 端到端测试 (e2e_test.sh)

测试覆盖以下完整业务流程：

#### 阶段 0: 准备工作
- 编译二进制文件
- 启动 Mock Server
- 等待服务器就绪

#### 阶段 1: 项目管理 (4个测试)
- ✅ 创建项目
- ✅ 查询项目详情
- ✅ 更新项目信息
- ✅ 列出所有项目

#### 阶段 2: 环境管理 (4个测试)
- ✅ 创建环境
- ✅ 查询环境详情
- ✅ 更新环境信息
- ✅ 列出项目的所有环境

#### 阶段 3: 规则管理 (5个测试)
- ✅ 创建 HTTP Mock 规则
- ✅ 查询规则详情
- ✅ 更新规则
- ✅ 创建带延迟的规则
- ✅ 列出所有规则

#### 阶段 4: Mock 请求测试 (5个测试)
- ✅ 测试基本 Mock 请求（GET）
- ✅ 测试自定义 Header
- ✅ 测试延迟响应
- ✅ 测试不匹配的请求（404）
- ✅ 测试 POST 请求

#### 阶段 5: 规则状态管理 (3个测试)
- ✅ 禁用规则
- ✅ 验证禁用后返回404
- ✅ 重新启用规则

#### 阶段 6: 清理测试数据 (3个测试)
- ✅ 删除规则
- ✅ 删除环境
- ✅ 删除项目

**总计**: 24 个集成测试场景

## 🚀 运行测试

### 前置条件

1. **MongoDB 数据库**
   ```bash
   # 确保 MongoDB 正在运行
   mongod --dbpath /path/to/data
   ```

2. **配置文件**
   - 确保 `config.yaml` 正确配置
   - 数据库连接字符串正确

3. **端口可用性**
   - 管理API端口: 8080
   - Mock服务端口: 9090

### 执行测试

```bash
# 进入项目根目录
cd /path/to/gomockserver

# 运行端到端测试
./tests/integration/e2e_test.sh
```

### 测试输出示例

```
=========================================
   Mock Server 端到端集成测试
=========================================

[阶段 0] 准备工作

[0.1] 检查二进制文件...
✓ 二进制文件存在

[0.2] 启动服务器...
✓ 服务器已启动 (PID: 12345)

[0.3] 等待服务器就绪...
✓ 服务器已就绪

[阶段 1] 项目管理测试

[1.1] 创建项目...
✓ 项目创建成功 (ID: 6565a1b2c3d4e5f6g7h8i9j0)

[1.2] 查询项目详情...
✓ 项目查询成功

...

=========================================
   测试结果统计
=========================================
通过测试: 24
失败测试: 0
总计测试: 24
✓ 所有测试通过！
```

## 📊 测试验证内容

### 1. API 接口验证
- HTTP 状态码正确性
- 响应体格式正确性
- 返回数据完整性

### 2. 业务逻辑验证
- 项目、环境、规则的 CRUD 操作
- 规则优先级和匹配逻辑
- 规则启用/禁用状态控制

### 3. Mock 功能验证
- 请求路由和匹配
- 响应内容生成
- 自定义 Header 设置
- 延迟响应功能

### 4. 数据一致性验证
- 创建后可查询
- 更新后数据改变
- 删除后不可查询

## 🔧 故障排查

### 服务器启动失败

**问题**: 服务器启动超时

**解决方案**:
1. 检查 MongoDB 是否运行
   ```bash
   ps aux | grep mongod
   ```

2. 检查端口是否被占用
   ```bash
   lsof -i :8080
   lsof -i :9090
   ```

3. 查看服务器日志
   ```bash
   tail -f /tmp/mockserver_e2e_test.log
   ```

### 测试失败

**问题**: 某些测试用例失败

**解决方案**:
1. 查看具体错误信息
2. 检查服务器日志
3. 验证数据库状态
4. 确认配置文件正确

### 端口冲突

**问题**: 端口已被占用

**解决方案**:
```bash
# 找到占用端口的进程
lsof -i :8080
lsof -i :9090

# 杀死进程
kill -9 <PID>
```

## 📈 性能基准

在正常环境下，端到端测试应该：

- **总执行时间**: < 30 秒
- **服务器启动时间**: < 5 秒
- **单个 API 调用**: < 100ms
- **Mock 请求响应**: < 50ms

如果超过这些时间，可能存在性能问题。

## 🔍 调试模式

如需调试，可以修改脚本：

```bash
# 在脚本开头添加调试输出
set -x  # 显示执行的每一条命令

# 或者只显示 curl 的详细信息
curl -v ...  # 替换 curl -s
```

## 📝 扩展测试

如需添加新的测试场景：

1. 在适当的阶段添加测试步骤
2. 使用 `test_pass` 和 `test_fail` 记录结果
3. 确保清理创建的测试数据

示例：
```bash
# 添加新测试
echo -e "${YELLOW}[X.X] 测试新功能...${NC}"
RESPONSE=$(curl -s ...)

if [ 条件满足 ]; then
    test_pass "新功能测试成功"
else
    test_fail "新功能测试失败"
fi
```

## 🏷️ 测试标签

- **类型**: 集成测试 (Integration Test)
- **级别**: E2E (End-to-End)
- **自动化**: 是
- **覆盖范围**: 完整业务流程
- **执行环境**: 本地 + CI/CD

## 📚 相关文档

- [测试方案](../../docs/testing/perfect-mvp-testing-plan.md)
- [API 文档](../../docs/api/)
- [主程序集成验证](../../docs/testing/MAIN_PROGRAM_INTEGRATION_VERIFICATION.md)

## 🤝 贡献指南

如需改进集成测试：

1. Fork 项目
2. 创建功能分支
3. 添加/修改测试
4. 提交 Pull Request

## 📞 联系方式

如有问题或建议：
- 查看日志: `/tmp/mockserver_e2e_test.log`
- 查看文档: `docs/testing/`
- 提交 Issue

---

**最后更新**: 2025-11-14  
**维护者**: AI Agent
