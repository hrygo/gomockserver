# 性能测试基准 (Benchmark)

**测试环境**: macOS / Ubuntu  
**工具**: wrk  
**版本**: 1.0  
**日期**: 2025-11-13

## 目标指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| QPS | >10,000 | 每秒请求数 |
| P50延迟 | <10ms | 50%请求延迟 |
| P95延迟 | <30ms | 95%请求延迟 |
| P99延迟 | <50ms | 99%请求延迟 |
| 错误率 | <0.1% | 错误请求比例 |

## 测试场景

### 场景1: 轻负载

**配置**:
- 线程数: 4
- 并发数: 10
- 持续时间: 30秒

**预期结果**:
- QPS: >5,000
- P99: <20ms
- 错误率: 0%

### 场景2: 中负载

**配置**:
- 线程数: 8
- 并发数: 100
- 持续时间: 60秒

**预期结果**:
- QPS: >10,000
- P99: <50ms
- 错误率: <0.1%

### 场景3: 高负载

**配置**:
- 线程数: 12
- 并发数: 500
- 持续时间: 120秒

**预期结果**:
- QPS: >15,000
- P99: <100ms
- 错误率: <0.5%

### 场景4: 压力测试

**配置**:
- 线程数: 16
- 并发数: 1000
- 持续时间: 60秒

**目标**: 找到系统性能极限

## 示例结果

```
Running 30s test @ http://localhost:9090/perf/test
  4 threads and 10 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.15ms    1.23ms  15.23ms   89.45%
    Req/Sec     1.25k    120.45    1.50k    75.32%
  149850 requests in 30.00s, 35.12MB read
Requests/sec:   4995.00
Transfer/sec:      1.17MB

延迟分布:
  50%: 2.05ms
  75%: 2.65ms
  90%: 3.45ms
  95%: 4.12ms
  99%: 6.78ms
```

## 性能调优建议

### 系统级优化

1. **TCP连接数**
```bash
# Linux
sysctl -w net.core.somaxconn=65535
sysctl -w net.ipv4.tcp_max_syn_backlog=8192
```

2. **文件描述符**
```bash
ulimit -n 100000
```

3. **Go运行时**
```bash
export GOMAXPROCS=8  # CPU核心数
export GOGC=100      # GC百分比
```

### 应用级优化

1. **连接池**: 配置合适的MongoDB连接池大小
2. **缓存**: 启用规则缓存
3. **日志**: 生产环境使用info级别

## 监控指标

测试时监控以下指标:

1. **CPU使用率**: <70%
2. **内存使用**: 稳定，无泄漏
3. **网络I/O**: 未达到瓶颈
4. **数据库连接**: 未耗尽

---

**注意**: 实际性能受硬件配置、网络环境、数据库性能等多种因素影响。
