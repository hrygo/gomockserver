name: CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GO_VERSION: '1.24'

jobs:
  # 单元测试任务
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Get dependencies
        run: |
          go mod download
          go mod verify

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run CI quality check
        run: |
          ./scripts/quality/ci-quality-check.sh

      - name: Run unit tests
        run: |
          go test -v -race -coverprofile=tests/coverage/coverage.out -covermode=atomic ./...

      - name: Generate coverage report
        run: |
          go tool cover -func=tests/coverage/coverage.out > tests/coverage/coverage.txt
          cat tests/coverage/coverage.txt

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./tests/coverage/coverage.out
          flags: unittests
          name: codecov-umbrella

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=tests/coverage/coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 50.0" | bc -l) )); then
            echo "Coverage is below 50%"
            exit 1
          fi

      - name: Archive coverage results
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            tests/coverage/coverage.out
            tests/coverage/coverage.txt

  # 集成测试任务
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Get dependencies
        run: go mod download
      
      - name: Build application
        run: |
          go build -v -o mockserver ./cmd/mockserver
          chmod +x mockserver
      
      - name: Start Mock Server
        run: |
          ./mockserver -config=config.yaml &
          echo $! > mockserver.pid
          sleep 10
        env:
          MONGODB_URI: mongodb://localhost:27017
      
      - name: Wait for server ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8080/api/v1/system/health > /dev/null; then
              echo "Server is ready"
              break
            fi
            echo "Waiting for server... ($i/30)"
            sleep 1
          done
      
      - name: Run integration tests
        run: |
          chmod +x tests/integration/e2e_test.sh
          ./tests/integration/e2e_test.sh
      
      - name: Stop Mock Server
        if: always()
        run: |
          if [ -f mockserver.pid ]; then
            kill $(cat mockserver.pid) || true
          fi
      
      - name: Archive test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: /tmp/mockserver_e2e_test.log

  # 代码质量检查
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m
      
      - name: Run go vet
        run: go vet ./...
      
      - name: Check formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -d .
            exit 1
          fi
      
      - name: Check for security issues
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'
      
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: results.sarif

  # 构建检查
  build:
    name: Build Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        arch: [amd64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Build
        run: go build -v -o mockserver ./cmd/mockserver
      
      - name: Verify binary
        if: runner.os != 'Windows'
        run: |
          ./mockserver --help || true
          file mockserver
